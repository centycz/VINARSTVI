<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√öƒçtov√°n√≠ - P≈ôehled stol≈Ø</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #ff5858 0%, #f09819 100%); min-height: 100vh; padding: 20px; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: white; font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);}
        .nav-links { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;}
        .nav-link { padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; text-decoration: none; border-radius: 25px; font-weight: 500; transition: all 0.3s ease;}
        .nav-link:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px);}
        .nav-link.active { background: white; color: #ff5858;}
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 15px; padding: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.1);}
        .section-title { font-size: 1.6em; color: #ff5858; margin: 25px 0 10px 0; font-weight: bold;}
        .orders-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px; margin-bottom: 30px;}
        .order-card { border: 3px solid #ff5858; border-radius: 15px; padding: 20px; background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.07); transition: transform 0.3s ease;}
        .order-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #eee;}
        .table-number { font-size: 1.3em; font-weight: bold; color: #f09819; display: flex; align-items: center; gap: 10px;}
        .order-time { color: #666; font-size: 0.95em;}
        .order-items { margin-bottom: 20px; }
        .bill-list { margin: 0 0 8px 0; padding: 0; list-style: none; }
        .bill-item { border-bottom: 1px solid #ffe4bf; padding: 6px 0; display: flex; justify-content: space-between; align-items: center;}
        .bill-item:last-child { border-bottom: none;}
        .bill-name {font-weight: bold;}
        .bill-qty {color: #999;}
        .bill-note {font-size: 0.93em; color: #b67100; font-style: italic;}
        .bill-status { font-size: 0.9em; border-radius: 5px; padding: 2px 8px; margin-left: 7px; color: #fff; background: #ff5858;}
        .bill-item.waiting { background: #ffeaea; }
        .bill-item.doruceno { background: #e0ffe5; }
        .bill-item.zaplaceno { background: #157347; color: #fff;}
        .bill-status.doruceno { background: #27ae60; color: #fff;}
        .bill-status.waiting { background: #ff5858; color: #fff;}
        .bill-status.zaplaceno { background: #0e472e; color: #fff;}
        .bill-total { font-weight: bold; color: #ff5858; font-size: 1.1em; text-align:right; margin-top: 7px;}
        .paid-info { color: #198754; font-size: 0.93em; margin-left: 8px;}
        .btn { padding: 8px 16px; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; transition: all 0.3s ease;}
        .btn-pay { background: #ff5858; color: white; margin-top: 9px;}
        .btn-pay:hover { background: #f09819; }
        .btn-split { background: #f09819; color: #fff; margin-top: 9px; margin-left: 7px;}
        .btn-split:hover { background: #ff5858; }
        .last-update { text-align: center; color: #666; font-size: 0.95em; margin-top: 15px;}
        .empty-state { text-align: center; padding: 40px 20px; color: #999;}
        .empty-state .icon { font-size: 4em; margin-bottom: 20px; display: block;}
        
        /* GLOB√ÅLN√ç MODAL BACKGROUND - JEDNOTN√ù PRO V≈†ECHNY MODALY */
        .modal-bg { 
            position: fixed; 
            left: 0; 
            top: 0; 
            width: 100vw; 
            height: 100vh; 
            background: rgba(0,0,0,0.6); 
            display: none;
            align-items: center; 
            justify-content: center; 
            z-index: 1000;
        }
      /* P≈ôidej k existuj√≠c√≠m styl≈Øm */
.quantity-selector {
    margin: 20px 0;
    text-align: center;
}

.quantity-selector label {
    display: block;
    margin-bottom: 10px;
    font-weight: bold;
    color: #333;
}

.quantity-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 15px;
}
/* P≈ôidej nebo uprav tyto CSS styly */
.bill-status.doruceno { 
    background: #28a745 !important;  /* ‚úÖ Zelen√° m√≠sto ƒçerven√© */
    color: #fff !important;
}

.bill-status.waiting { 
    background: #ff5858 !important;  /* ‚úÖ ƒåerven√° pro ƒçekaj√≠c√≠ */
    color: #fff !important;
}

.bill-status.zaplaceno { 
    background: #0e472e !important;  /* ‚úÖ Tmavƒõ zelen√° pro zaplaceno */
    color: #fff !important;
}

.bill-status.cancelled { 
    background: #721c24 !important;  /* ‚úÖ Tmavƒõ ƒçerven√° pro zru≈°eno */
    color: white !important;
}

/* Styly pro cel√© ≈ô√°dky polo≈æek */
.bill-item.doruceno { 
    background: #e0ffe5 !important;  /* ‚úÖ Svƒõtle zelen√° pro doruƒçen√© */
}

.bill-item.waiting { 
    background: #ffeaea !important;  /* ‚úÖ Svƒõtle ƒçerven√° pro ƒçekaj√≠c√≠ */
}

.bill-item.zaplaceno { 
    background: #157347 !important;  /* ‚úÖ Zelen√° pro zaplacen√© */
    color: #fff !important;
}

.bill-item.cancelled {
    background: #f8d7da !important;  /* ‚úÖ R≈Ø≈æov√° pro zru≈°en√© */
    color: #721c24 !important;
    text-decoration: line-through;
    opacity: 0.7;
}

.table-select-btn.selected {
    background: #007bff !important;
    color: white !important;
    border-color: #007bff !important;
}
.quantity-controls button {
    background: #007bff;
    color: white;
    border: none;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.quantity-controls button:hover {
    background: #0056b3;
    transform: scale(1.1);
}

.quantity-controls button:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
}

.quantity-controls input {
    width: 80px;
    height: 40px;
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    border: 2px solid #007bff;
    border-radius: 8px;
}

.cancel-reason {
    margin: 20px 0;
}

.cancel-reason label {
    display: block;
    margin-bottom: 10px;
    font-weight: bold;
    color: #333;
}

.cancel-reason input {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

.status-indicator {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: bold;
    margin-left: 5px;
}

.status-indicator.pending {
    background: #fff3cd;
    color: #856404;
}

.status-indicator.preparing {
    background: #d1ecf1;
    color: #0c5460;
}

.status-indicator.ready {
    background: #d4edda;
    color: #155724;
}

.status-indicator.delivered {
    background: #d1ecf1;
    color: #0c5460;
}
      
       /* Styly pro tlaƒç√≠tko zru≈°en√≠ */
.btn-cancel-item {
    background: #dc3545;
    color: white;
    font-size: 12px;
    padding: 4px 8px;
    margin-left: 8px;
    border-radius: 4px;
}

.btn-cancel-item:hover {
    background: #c82333;
}

/* Modal pro potvrzen√≠ zru≈°en√≠ */
.cancel-item-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.cancel-item-content {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    min-width: 400px;
    max-width: 90vw;
    text-align: center;
}

.cancel-item-title {
    color: #dc3545;
    margin-bottom: 20px;
    font-size: 1.5em;
    font-weight: bold;
}

.cancel-item-info {
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.cancel-item-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 25px;
}

.cancel-item-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.cancel-item-btn.confirm {
    background: #dc3545;
    color: white;
}

.cancel-item-btn.confirm:hover {
    background: #c82333;
}

.cancel-item-btn.cancel {
    background: #6c757d;
    color: white;
}

.cancel-item-btn.cancel:hover {
    background: #5a6268;
}
.status-indicator.paid {
    background: #157347;
    color: white;
}

.status-indicator.cancelled {
    background: #721c24;
    color: white;
}

.bill-status.cancelled {
    background: #721c24 !important;
    color: white !important;
}

/* Styles for fully paid tables */
.fully-paid-table {
    border-color: #28a745 !important;
    background: #f8fff9 !important;
}

.paid-badge {
    background: #28a745;
    color: white;
    font-size: 0.8em;
    padding: 2px 8px;
    border-radius: 12px;
    margin-left: 10px;
    font-weight: bold;
}

.btn-reprint {
    background: #28a745;
    color: white;
}

.btn-reprint:hover {
    background: #218838;
}

.btn-close-table {
    background: #6c757d;
    color: white;
}

.btn-close-table:hover {
    background: #5a6268;
}
       
        /* P≈ôidej k existuj√≠c√≠m styl≈Øm */
.btn-change-table {
    background: #17a2b8;
    color: white;
    margin-top: 9px;
    margin-left: 7px;
}
.btn-change-table:hover {
    background: #138496;
}

/* Modal pro zmƒõnu stolu */
.table-change-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.table-change-content {
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    min-width: 400px;
    max-width: 90vw;
}

.table-change-title {
    color: #ff5858;
    margin-bottom: 20px;
    font-size: 1.5em;
    font-weight: bold;
    text-align: center;
}

.table-select-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 10px;
    margin: 20px 0;
    max-height: 300px;
    overflow-y: auto;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
}

.table-select-btn {
    min-height: 50px;
    border: 2px solid #ddd;
    background: #f8f9fa;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.table-select-btn:hover {
    border-color: #ff5858;
    background: #fff5f5;
}

.table-select-btn.occupied {
    background: #e53e3e;
    color: white;
    border-color: #e53e3e;
}

.table-select-btn.current {
    background: #28a745;
    color: white;
    border-color: #28a745;
}

.table-change-buttons {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-top: 20px;
}

.table-change-btn {
    padding: 12px 25px;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
}

.table-change-btn.confirm {
    background: #28a745;
    color: white;
}

.table-change-btn.confirm:hover {
    background: #218838;
}

.table-change-btn.cancel {
    background: #dc3545;
    color: white;
}

.table-change-btn.cancel:hover {
    background: #c82333;
}
        /* SPOLEƒåN√ù STYL PRO V≈†ECHNY MODALY */
        .modal, .confirm-modal { 
            min-width: 600px;
            max-width: 90vw;
            max-height: 90vh;
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.3); 
            padding: 40px 50px; 
            position: relative;
            overflow-y: auto;
            margin: 20px;
        }
        
        /* SPOLEƒåN√ù STYL PRO NADPISY V≈†ECH MODAL≈Æ */
        .modal h3, .confirm-modal h3 {
            color: #ff5858; 
            margin-bottom: 30px; 
            font-size: 1.8em;
            font-weight: bold;
            text-align: center;
        }
        
        /* Styly pro seznam polo≈æek v rozdƒõlovac√≠m modalu */
        .modal-list {
            list-style: none; 
            padding: 0; 
            margin: 0 0 25px 0;
        }
        
        .modal-item {
            margin-bottom: 18px; 
            font-size: 1.1em;
        }
        
        /* Styl pro celkovou ƒç√°stku */
        .modal-total {
            margin-top: 20px; 
            font-weight: bold; 
            font-size: 1.4em; 
            text-align: center; 
            color: #ff5858;
        }
        
        /* Styly pro tlaƒç√≠tka + a - */
        .quantity-buttons {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .quantity-button {
            background-color: #ddd;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 1.2em;
            font-weight: bold;
            min-width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-button:hover {
            background-color: #bbb;
        }
        
        /* SPOLEƒåN√ù STYL PRO SEKCE V√ùBƒöRU PLATBY */
        .modal-payment-section, .payment-method-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .modal-payment-label, .payment-method-label {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-payment-options, .payment-options {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin: 25px 0;
        }

        .modal-payment-option, .payment-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            padding: 20px;
            border: 3px solid #ddd;
            border-radius: 15px;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .modal-payment-option:hover, .payment-option:hover {
            border-color: #ff5858;
            background-color: #fff8f8;
        }

        .modal-payment-option.selected, .payment-option.selected {
            border-color: #ff5858;
            background-color: #fff0f0;
        }

        .modal-payment-option input[type="radio"], .payment-option input[type="radio"] {
            display: none;
        }

        .modal-payment-icon, .payment-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .modal-payment-text, .payment-text {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        /* SPOLEƒåN√ù STYL PRO TLAƒå√çTKA V≈†ECH MODAL≈Æ */
        .modal-btns, .confirm-modal-btns {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 40px;
        }

        .modal-btn, .confirm-modal-btn {
            padding: 18px 40px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1.3em;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 180px;
        }

        /* Zelen√© tlaƒç√≠tko pro zaplacen√≠ */
        .modal-btn:not(.cancel), .confirm-modal-btn.ok {
            background-color: #28a745;
            color: white;
        }

        .modal-btn:not(.cancel):hover, .confirm-modal-btn.ok:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }

        /* ƒåerven√© tlaƒç√≠tko pro zru≈°en√≠ */
        .modal-btn.cancel, .confirm-modal-btn.cancel {
            background-color: #dc3545;
            color: white;
        }

        .modal-btn.cancel:hover, .confirm-modal-btn.cancel:hover {
            background-color: #c82333;
            transform: translateY(-2px);
        }

        /* Style pro informaci o platbƒõ */
        .previous-payment-info {
            font-size: 0.9em;
            color: #777;
            margin-top: 5px;
        }

        /* Responsive design pro men≈°√≠ obrazovky */
        @media (max-width: 768px) {
            .modal, .confirm-modal {
                min-width: 95vw;
                padding: 30px 20px;
                margin: 10px;
            }
            
            .modal-btn, .confirm-modal-btn {
                padding: 15px 25px;
                font-size: 1.1em;
                min-width: 140px;
            }
            
            .modal-payment-options, .payment-options {
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }
            
            .modal-payment-option, .payment-option {
                min-width: 200px;
            }
        }


    </style>
</head>
<body>
    <div class="header">
        <h1>üí∞ √öƒçtov√°n√≠</h1>
        <div class="nav-links">
            <a href="index.html" class="nav-link" id="nav-obsluha">üè† Objedn√°vky</a>
            <a href="kitchen.html" class="nav-link" id="nav-kuchyn">üë®‚Äçüç≥ Kuchy≈à</a>
<a href="pasta-kuchyn.html" class="nav-link " id="nav-pasta">üçù Pasta kuchy≈à</a>
            <a href="bar.html" class="nav-link" id="nav-bar">üç∫ Bar</a>
            <a href="serving.html" class="nav-link" id="nav-servirovani">üçΩÔ∏è Serv√≠rov√°n√≠</a>
            <a href="billing.html" class="nav-link active" id="nav-uctovani">üí∞ √öƒçtov√°n√≠</a>
            <a href="historie.html" class="nav-link">üìã Historie</a>
        </div>
    </div>
    <div class="container">
        <div class="section-title">Aktu√°ln√≠ obsazen√© stoly s objedn√°vkami</div>
        <div class="orders-grid" id="ordersContainer"></div>
        <div class="last-update">Posledn√≠ aktualizace: <span id="lastUpdate">-</span></div>
    </div>

    <!-- Glob√°ln√≠ kontejner pro V≈†ECHNY modaly -->
    <div id="modal-bg" class="modal-bg" style="display:none"></div>
<div id="tableChangeModal" class="table-change-modal">
    <div class="table-change-content">
        <div class="table-change-title">Zmƒõnit st≈Øl objedn√°vky</div>
        <div>
            <p><strong>Aktu√°ln√≠ st≈Øl:</strong> <span id="currentTableName"></span></p>
            <p><strong>Celkov√° ƒç√°stka:</strong> <span id="orderTotalAmount"></span></p>
        </div>
        <div class="table-select-grid" id="tableSelectGrid">
            <!-- Stoly se naƒçtou dynamicky -->
        </div>
        <div class="table-change-buttons">
            <button class="table-change-btn confirm" onclick="confirmTableChange()" id="confirmChangeBtn" disabled>
                Zmƒõnit st≈Øl
            </button>
            <button class="table-change-btn cancel" onclick="closeTableChangeModal()">
                Zru≈°it
            </button>
        </div>
    </div>
</div>
    <script>
    const API = 'api/restaurant-api.php';
    let tables = [];
    let lastSplitTable = null, lastSplitGroups = [];
    let lastSplitBillData = null; // Store bill data for receipt functionality
    let currentTableToPay = null;

    // ‚úÖ NOV√Å LOGIKA - Rozdƒõl√≠ polo≈æky podle statusu m√≠sto seskupov√°n√≠
    function groupBillItems(items) {
        let result = [];
        
        // Seskup podle n√°zvu, ceny a pozn√°mky
        let nameGroups = {};
        for (let item of items) {
            let groupKey = item.item_name + "|" + item.unit_price + "|" + (item.note||'');
            if (!nameGroups[groupKey]) {
                nameGroups[groupKey] = [];
            }
            nameGroups[groupKey].push(item);
        }
        
        // Pro ka≈ædou skupinu n√°zvu vytvo≈ôit samostatn√© ≈ô√°dky podle statusu
        for (let groupKey in nameGroups) {
            let itemsInGroup = nameGroups[groupKey];
            
            // Seskup podle statusu
            let statusGroups = {};
            for (let item of itemsInGroup) {
                if (!statusGroups[item.status]) {
                    statusGroups[item.status] = [];
                }
                statusGroups[item.status].push(item);
            }
            
            // Vytvo≈ô ≈ô√°dek pro ka≈æd√Ω status
            for (let status in statusGroups) {
                let statusItems = statusGroups[status];
                let totalQty = statusItems.reduce((sum, item) => sum + Number(item.quantity), 0);
                
                result.push({
                    item_name: statusItems[0].item_name,
                    unit_price: Number(statusItems[0].unit_price),
                    note: statusItems[0].note,
                    qty: totalQty,
                    ids: statusItems.map(item => item.id),
                    all_items: statusItems,
                    status: status
                });
            }
        }
        
        return result;
    }

    // ‚úÖ OPRAVEN√Å FUNKCE - nahraƒète existuj√≠c√≠ loadTables() funkc√≠
async function loadTables() {
    console.log('=== LOAD TABLES DEBUG ===');
    
    // 1. Naƒçti v≈°echny stoly
    const tRes = await fetch(API + '?action=tables');
    let allTables = [];
    try { 
        const res = await tRes.json();
        console.log('All tables response:', res);
        allTables = res.data && res.data.tables ? res.data.tables : []; 
    } catch(e){
        console.error('Error loading tables:', e);
    }
    
    console.log('All tables count:', allTables.length);
    console.log('All tables:', allTables);
    
    // ‚úÖ OPRAVA: Nezamƒõ≈ôovat jen na obsazen√© stoly, ale na v≈°echny s aktivn√≠ session
    let filtered = [];
    
    for (const table of allTables) {
        console.log(`\n--- Processing table ${table.table_number} (${table.table_code}) ---`);
        console.log('Table status:', table.status);
        
        // ‚úÖ OPRAVA: Naƒçti bill pro ka≈æd√Ω st≈Øl bez ohledu na status - USE get-bill
        const billRes = await fetch(API + '?action=get-bill&table=' + table.table_number);
        let items = [];
        try { 
            const bill = await billRes.json();
            console.log('Bill response for table', table.table_number, ':', bill);
            if (bill.success && bill.data && bill.data.items) {
                // Filter items with outstanding quantity > 0
                items = bill.data.items.filter(item => {
                    const outstandingQty = getItemValue(item, 'qty_outstanding', 'outstanding_qty', 'outstanding_quantity');
                    return outstandingQty > 0;
                });
            }
        } catch(e){
            console.error('Error loading bill for table', table.table_number, ':', e);
        }
        
        console.log('Items count for table', table.table_number, ':', items.length);
        console.log('Items:', items);
        
        // Calculate amounts based on get-bill data structure
        let outstandingAmount = 0;
        const hasOutstandingItems = items.length > 0;
        
        items.forEach(item => {
            const outstandingQty = getItemValue(item, 'qty_outstanding', 'outstanding_qty', 'outstanding_quantity');
            const unitPrice = parseFloat(getItemValue(item, 'unit_price', 'price')) || 0;
            outstandingAmount += unitPrice * outstandingQty;
        });

        // Check if this table has any items at all (from get-bill API)
        const billResponseData = await fetch(API + '?action=get-bill&table=' + table.table_number);
        let hasAnyItemsEver = false;
        let fullyPaidItems = [];
        
        try {
            const fullBill = await billResponseData.json();
            if (fullBill.success && fullBill.data && fullBill.data.items) {
                hasAnyItemsEver = fullBill.data.items.length > 0;
                // Check for items that were paid (qty_paid > 0)
                fullyPaidItems = fullBill.data.items.filter(item => {
                    const paidQty = getItemValue(item, 'qty_paid', 'paid_qty', 'paid_quantity') || 0;
                    return paidQty > 0;
                });
            }
        } catch(e) {
            console.error('Error getting full bill for table', table.table_number, ':', e);
        }

        // Include table in display if:
        // 1. It has outstanding items (needs payment), OR
        // 2. It has fully paid items (show with "Uhrazeno" badge temporarily)
        const shouldShowTable = hasOutstandingItems || fullyPaidItems.length > 0;
        
        if (!shouldShowTable) {
            console.log('Skipping table', table.table_number, '- no items or payments');
            continue;
        }

        // Set table data for rendering
        table.outstandingAmount = outstandingAmount;
        table.billItems = items; // Outstanding items only for payment
        table.fullyPaid = !hasOutstandingItems && fullyPaidItems.length > 0; // Flag for "Uhrazeno" badge
        table.hasAnyItems = hasAnyItemsEver;
        
        console.log('Adding table', table.table_number, 'to filtered list');
        console.log('Outstanding amount:', outstandingAmount);
        console.log('Fully paid?', table.fullyPaid);
        
        filtered.push(table);
    }
    
    console.log('Final filtered tables count:', filtered.length);
    console.log('Final filtered tables:', filtered.map(t => `${t.table_number}(${t.table_code})`));
    
    tables = filtered;
    renderTables();
    updateLastUpdateTime();
}

   // P≈òIDEJ TYTO PROMƒöNN√â NA ZAƒå√ÅTEK <script> SEKCE
let currentChangeSession = null;
let selectedNewTable = null;
let availableTables = [];



// P≈òIDEJ TYTO NOV√â FUNKCE:
async function showTableChangeModal(tableNumber, tableCode, totalAmount) {
    currentChangeSession = tableNumber;
    selectedNewTable = null;
    
    document.getElementById('currentTableName').textContent = tableCode;
    document.getElementById('orderTotalAmount').textContent = formatCurrency(totalAmount);
    
    // Naƒçti v≈°echny stoly
    await loadAllTablesForChange();
    
    document.getElementById('tableChangeModal').style.display = 'flex';
}

function closeTableChangeModal() {
    document.getElementById('tableChangeModal').style.display = 'none';
    currentChangeSession = null;
    selectedNewTable = null;
}

async function loadAllTablesForChange() {
    try {
        const response = await fetch(`${API}?action=tables`);
        const result = await response.json();
        
        if (result.success) {
            availableTables = result.data.tables || [];
            renderTableSelectGrid();
        }
    } catch (error) {
        console.error('Chyba p≈ôi naƒç√≠t√°n√≠ stol≈Ø:', error);
    }
}

function renderTableSelectGrid() {
    const grid = document.getElementById('tableSelectGrid');
    
    grid.innerHTML = availableTables.map(table => {
        let buttonClass = 'table-select-btn';
        let buttonText = table.table_code || `St≈Øl ${table.table_number}`;
        
        if (table.table_number === currentChangeSession) {
            buttonClass += ' current';
            buttonText += ' (Aktu√°ln√≠)';
        } else if (table.status === 'occupied') {
            buttonClass += ' occupied';
            buttonText += ' (Obsazen)';
        }
        
        return `
            <button class="${buttonClass}" 
                    onclick="selectNewTable(${table.table_number}, '${table.table_code || `St≈Øl ${table.table_number}`}')"
                    ${table.table_number === currentChangeSession ? 'disabled' : ''}>
                ${buttonText}
            </button>
        `;
    }).join('');
}

function selectNewTable(tableNumber, tableCode) {
    // Odeber p≈ôedchoz√≠ v√Ωbƒõr
    document.querySelectorAll('.table-select-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    // Oznaƒç nov√Ω v√Ωbƒõr
    event.target.classList.add('selected');
    selectedNewTable = tableNumber;
    
    // Povol tlaƒç√≠tko zmƒõny
    const confirmBtn = document.getElementById('confirmChangeBtn');
    confirmBtn.disabled = false;
    confirmBtn.textContent = `P≈ôesunout na ${tableCode}`;
}

async function confirmTableChange() {
    if (!currentChangeSession || !selectedNewTable) return;
    
    const confirmBtn = document.getElementById('confirmChangeBtn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'P≈ôesouv√°m...';
    
    try {
        const response = await fetch(`${API}?action=change-table`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                from_table: currentChangeSession,
                to_table: selectedNewTable
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('St≈Øl byl √∫spƒõ≈°nƒõ zmƒõnƒõn!');
            closeTableChangeModal();
            loadTables(); // Reload √∫ƒçtovac√≠ch dat
        } else {
            alert('Chyba p≈ôi zmƒõnƒõ stolu: ' + (result.error || 'Nezn√°m√° chyba'));
        }
    } catch (error) {
        console.error('Chyba p≈ôi zmƒõnƒõ stolu:', error);
        alert('Chyba p≈ôi zmƒõnƒõ stolu: ' + error.message);
    } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'Zmƒõnit st≈Øl';
    }
}

// P≈ôidej helper funkci pro form√°tov√°n√≠ mƒõny (pokud nen√≠ definovan√°)
function formatCurrency(amount) {
    return new Intl.NumberFormat('cs-CZ', {
        style: 'currency',
        currency: 'CZK',
        minimumFractionDigits: 0
    }).format(amount);
}

 
    function statusLabel(status) {
    if(status === 'delivered') return {text:'Doruƒçeno', css:'doruceno'};
    if(status === 'paid') return {text:'ZAPLACENO', css:'zaplaceno'};
    if(status === 'cancelled') return {text:'ZRU≈†ENO', css:'cancelled'};
    return {text:'ƒåek√° na doruƒçen√≠', css:'waiting'};  // ‚úÖ Zmƒõnƒõno z 'Doruƒçov√°na'
}
function getBillItemClass(status) {
    switch(status) {
        case 'paid': return 'zaplaceno';
        case 'delivered': return 'doruceno';
        case 'cancelled': return 'cancelled';
        case 'pending':
        case 'preparing':
        case 'ready':
        default: return 'waiting';
    }
}

  function renderTables() {
    const container = document.getElementById('ordersContainer');
    if (tables.length === 0) {
        container.innerHTML = `<div class="empty-state">
            <span class="icon">üçΩÔ∏è</span>
            <h3>≈Ω√°dn√Ω obsazen√Ω st≈Øl s √∫ƒçtem</h3>
            <p>Moment√°lnƒõ nen√≠ co √∫ƒçtovat</p>
        </div>`;
        return;
    }
    
    container.innerHTML = tables.map(t => {
        const items = t.billItems || [];
        const outstandingAmount = t.outstandingAmount || 0;
        const hasAnyItems = t.hasAnyItems || false;
        const fullyPaid = t.fullyPaid || false;

        return `
        <div class="order-card ${fullyPaid ? 'fully-paid-table' : ''}">
    <div class="order-header">
        <div class="table-number">
            ${t.table_code}
            ${fullyPaid ? '<span class="paid-badge">Uhrazeno</span>' : ''}
        </div>
        <div class="order-time">${t.status === 'occupied' ? 'Obsazeno' : t.status}</div>
    </div>
    <div class="order-items">
        <ul class="bill-list">
        ${items.map(item => {
            const itemName = getItemValue(item, 'name', 'item_name');
            const outstandingQty = getItemValue(item, 'qty_outstanding', 'outstanding_qty', 'outstanding_quantity');
            const unitPrice = parseFloat(getItemValue(item, 'unit_price', 'price')) || 0;
            const itemTotal = outstandingQty * unitPrice;
            
            return `
            <li class="bill-item">
                <span>
                    <span class="bill-name">${itemName}</span>
                    ${outstandingQty > 1 ? `<span class="bill-qty">(${outstandingQty}√ó zb√Ωv√°)</span>` : ""}
                </span>
                <span>${itemTotal} Kƒç</span>
            </li>
            `;
        }).join('')}
        </ul>
        <div class="bill-total">
            ${fullyPaid ? 'V≈°e zaplaceno' : `Zb√Ωv√° k √∫hradƒõ: ${formatCurrency(outstandingAmount)}`}
        </div>
    </div>
    <div class="order-actions">
        ${fullyPaid ? `
            <button class="btn btn-reprint" onclick="showReprintOptions(${t.table_number})" style="background: #28a745;">
                üìÑ REPRINT
            </button>
            <button class="btn btn-close-table" onclick="confirmCloseTable(${t.table_number}, '${t.table_code}')" style="background: #6c757d;">
                ‚úñ ZAV≈ò√çT
            </button>
        ` : `
            <button class="btn btn-pay" onclick="showPaymentModal(${t.table_number}, this)" ${!hasAnyItems ? 'disabled' : ''} style="${!hasAnyItems ? 'opacity:0.5;' : ''}">
                PLATBA
            </button>
            <button class="btn btn-change-table" onclick="showTableChangeModal(${t.table_number}, '${t.table_code}', ${outstandingAmount})">
                ZMƒöNIT ST≈ÆL
            </button>
        `}
    </div>
</div>
`;
    }).join('');
}

// LEGACY MODAL - COMMENTED OUT - REPLACED BY UNIFIED PAYMENT MODAL
/*
function showConfirmModal(table_number) {
    currentTableToPay = table_number;
    
    console.log('=== SHOWCONFIRMMODAL DEBUG ===');
    console.log('Table number:', table_number);
    console.log('All tables:', tables);
    
    const table = tables.find(t => t.table_number == table_number); // ‚úÖ Pou≈æij == m√≠sto ===
    console.log('Found table:', table);
    
    if (table && table.billItems) {
        console.log('Bill items for table:', table.billItems);
        
        // Projdi ka≈ædou polo≈æku
        table.billItems.forEach(item => {
            console.log(`Item: ${item.item_name}, Status: ${item.status}, Qty: ${item.qty}, Unit price: ${item.unit_price}, Total: ${item.qty * item.unit_price}`);
        });
    }
    
    let totalAmount = 0;
    
    if (table && table.outstandingAmount) {
        totalAmount = table.outstandingAmount;
        console.log('Outstanding amount:', totalAmount);
    }
    
    console.log('Final amount:', totalAmount);
    console.log('=== END DEBUG ===');
    
    const modalBg = document.getElementById('modal-bg');
    modalBg.style.display = 'flex';

    modalBg.innerHTML = `
        <div class="confirm-modal">
            <h3>Zaplatit celou objedn√°vku?</h3>
            
            <div class="payment-amounts" style="margin: 20px 0;">
                <div style="
                    background: #e3f2fd;
                    border: 2px solid #2196F3;
                    border-radius: 8px;
                    padding: 15px;
                    margin-bottom: 10px;
                    text-align: center;
                ">
                    <div style="font-size: 14px; color: #1976D2; margin-bottom: 8px;">üí∞ Zb√Ωvaj√≠c√≠ ƒç√°stka k √∫hradƒõ</div>
                    <div style="font-size: 24px; font-weight: bold; color: #1976D2;">${totalAmount} Kƒç</div>
                </div>
            </div>
            
            <div class="payment-method-section">
                <div class="payment-method-label">Vyberte zp≈Øsob platby:</div>
                <div class="payment-options">
                    <label class="payment-option selected" for="payment-cash">
                        <input type="radio" id="payment-cash" name="payment-method" value="cash" checked>
                        <div class="payment-icon">üíµ</div>
                        <div class="payment-text">Hotovost</div>
                    </label>
                    <label class="payment-option" for="payment-card">
                        <input type="radio" id="payment-card" name="payment-method" value="card">
                        <div class="payment-icon">üí≥</div>
                        <div class="payment-text">Karta</div>
                    </label>
                </div>
            </div>

            <div class="confirm-modal-btns">
                <button class="confirm-modal-btn ok" onclick="confirmPayAll()">ZAPLATIT ${totalAmount} Kƒç</button>
                <button class="confirm-modal-btn cancel" onclick="closeModal()">ZPƒöT</button>
            </div>
        </div>
    `;
    
    setupPaymentOptionListeners('.payment-option');
}
*/

// LEGACY MODAL - REDIRECTS TO NEW UNIFIED MODAL FOR CONSISTENCY
function showSplitModal(outstandingItems, billData) {
    // Redirect all old split modal calls to the new unified payment modal
    showUnifiedPaymentModal(outstandingItems, billData);
}

// LEGACY FUNCTION - COMMENTED OUT - REPLACED BY UNIFIED AGGREGATED ITEMS
/*
function generateOutstandingItemsHTML(outstandingItems) {
    return outstandingItems.map((item, idx) => {
        const outstandingQty = getItemValue(item, 'qty_outstanding', 'outstanding_qty');
        const itemName = getItemValue(item, 'name', 'item_name');
        const unitPrice = parseFloat(getItemValue(item, 'unit_price', 'price')) || 0;
        const itemId = getItemValue(item, 'id', 'item_id');
        
        return `
            <tr>
                <td style="padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd;">${itemName}</td>
                <td style="padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd;">${formatCurrency(unitPrice)}</td>
                <td style="padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd;">${outstandingQty}</td>
                <td style="padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd;">
                    <input type="number" class="split-qty-input" min="0" max="${outstandingQty}" value="0" 
                           data-item-id="${itemId}" data-unit-price="${unitPrice}" data-index="${idx}"
                           style="width: 60px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;"
                           onchange="calculateSplitTotal()">
                </td>
                <td class="split-item-amount" style="padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd;">0 Kƒç</td>
            </tr>
        `;
    }).join('');
}
*/

// Helper function to generate receipt history HTML
function generateReceiptHistoryHTML(priorReceipts) {
    if (!priorReceipts || priorReceipts.length === 0) {
        return `
            <div style="margin-top: 20px; border-top: 2px solid #f09819; padding-top: 15px; display: none;" id="split-history-section">
                <div style="font-size: 1.1em; font-weight: bold; color: #f09819; margin-bottom: 10px;">üìã Historie √∫ƒçtenek</div>
                <div style="text-align: center; padding: 20px; color: #666;">≈Ω√°dn√© p≈ôedchoz√≠ √∫ƒçtenky</div>
            </div>
        `;
    }

    return `
        <div style="margin-top: 20px; border-top: 2px solid #f09819; padding-top: 15px;" id="split-history-section">
            <div style="font-size: 1.1em; font-weight: bold; color: #f09819; margin-bottom: 10px;">üìã Historie √∫ƒçtenek pro tento st≈Øl</div>
            <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                <thead>
                    <tr>
                        <th style="background: #f8f9fa; font-weight: bold; padding: 6px 10px; text-align: left; border-bottom: 1px solid #eee;">ƒå√≠slo</th>
                        <th style="background: #f8f9fa; font-weight: bold; padding: 6px 10px; text-align: left; border-bottom: 1px solid #eee;">ƒå√°stka</th>
                        <th style="background: #f8f9fa; font-weight: bold; padding: 6px 10px; text-align: left; border-bottom: 1px solid #eee;">Zp≈Øsob platby</th>
                        <th style="background: #f8f9fa; font-weight: bold; padding: 6px 10px; text-align: left; border-bottom: 1px solid #eee;">Obsluha</th>
                        <th style="background: #f8f9fa; font-weight: bold; padding: 6px 10px; text-align: left; border-bottom: 1px solid #eee;">ƒåas</th>
                        <th style="background: #f8f9fa; font-weight: bold; padding: 6px 10px; text-align: left; border-bottom: 1px solid #eee;">Akce</th>
                    </tr>
                </thead>
                <tbody>
                    ${priorReceipts.map(receipt => {
                        const receiptNumber = getItemValue(receipt, 'receipt_number', 'number');
                        const totalAmount = parseFloat(getItemValue(receipt, 'total_amount', 'amount')) || 0;
                        const paymentMethod = getItemValue(receipt, 'payment_method', 'method') || 'cash';
                        const employeeName = getItemValue(receipt, 'employee_name', 'employee') || '-';
                        const createdAt = getItemValue(receipt, 'paid_at', 'created_at');
                        
                        const paymentMethodText = {
                            'cash': 'Hotovost',
                            'card': 'Karta'
                        }[paymentMethod] || paymentMethod;
                        
                        return `
                            <tr>
                                <td style="padding: 6px 10px; text-align: left; border-bottom: 1px solid #eee;">#${receiptNumber}</td>
                                <td style="padding: 6px 10px; text-align: left; border-bottom: 1px solid #eee;">${formatCurrency(totalAmount)}</td>
                                <td style="padding: 6px 10px; text-align: left; border-bottom: 1px solid #eee;">${paymentMethodText}</td>
                                <td style="padding: 6px 10px; text-align: left; border-bottom: 1px solid #eee;">${employeeName}</td>
                                <td style="padding: 6px 10px; text-align: left; border-bottom: 1px solid #eee;">${formatDateTime(createdAt)}</td>
                                <td style="padding: 6px 10px; text-align: left; border-bottom: 1px solid #eee;">
                                    <button onclick="reprintReceipt(${receiptNumber})" 
                                            style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                                        Reprint
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        </div>
    `;
}

// Setup quantity input listeners
function setupQuantityInputListeners() {
    document.querySelectorAll('.split-qty-input').forEach(input => {
        input.addEventListener('input', updateUnifiedModalTotals);
        input.addEventListener('change', updateUnifiedModalTotals);
    });
}

// LEGACY FUNCTION - COMMENTED OUT - REPLACED BY UNIFIED MODAL TOTALS CALCULATION
/*
function calculateSplitTotal() {
    const qtyInputs = document.querySelectorAll('.split-qty-input');
    let total = 0;
    
    qtyInputs.forEach(input => {
        const qty = parseInt(input.value) || 0;
        const unitPrice = parseFloat(input.dataset.unitPrice) || 0;
        const amount = qty * unitPrice;
        
        // Update item amount display
        const row = input.closest('tr');
        const amountCell = row.querySelector('.split-item-amount');
        if (amountCell) {
            amountCell.textContent = formatCurrency(amount);
        }
        
        total += amount;
    });
    
    const totalDisplay = document.getElementById('split-total-display');
    if (totalDisplay) {
        totalDisplay.textContent = `Celkem k √∫hradƒõ: ${formatCurrency(total)}`;
    }
}
*/

// Reprint receipt function
async function reprintReceipt(receiptNumber) {
    try {
        const response = await fetch(`${API}?action=reprint-receipt&receipt_number=${receiptNumber}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('√öƒçtenka byla znovu vyti≈°tƒõna.');
        } else {
            throw new Error(result.error || 'Chyba p≈ôi doti≈°tƒõn√≠ √∫ƒçtenky');
        }
        
    } catch (error) {
        console.error('Error reprinting receipt:', error);
        alert('Chyba p≈ôi doti≈°tƒõn√≠ √∫ƒçtenky: ' + error.message);
    }
}

function setupPaymentOptionListeners(selector) {
    document.querySelectorAll(selector).forEach(option => {
        option.addEventListener('click', function() {
            // Odstran√≠me selected ze v≈°ech mo≈ænost√≠ tohoto typu
            document.querySelectorAll(selector).forEach(opt => opt.classList.remove('selected'));
            // P≈ôid√°me selected k aktu√°ln√≠ mo≈ænosti
            this.classList.add('selected');
            // Oznaƒç√≠me p≈ô√≠slu≈°n√Ω radio button
            this.querySelector('input[type="radio"]').checked = true;
        });
    });
}

// SPOLEƒåN√Å FUNKCE PRO ZAV≈òEN√ç V≈†ECH MODAL≈Æ
function closeModal() {
    const modalBg = document.getElementById('modal-bg');
    modalBg.style.display = 'none';
    modalBg.innerHTML = '';
    currentTableToPay = null;
}

// LEGACY FUNCTION - COMMENTED OUT - REPLACED BY UNIFIED PAYMENT MODAL
/*
function confirmPayAll() {
    const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
    console.log('Zp≈Øsob platby:', paymentMethod);
    payAll(currentTableToPay, null, paymentMethod);  // ‚úÖ P≈òID√ÅN paymentMethod
    closeModal();
}
*/

// LEGACY FUNCTION - COMMENTED OUT - REPLACED BY UNIFIED PAYMENT MODAL
/*
function payAll(table_number, btn, paymentMethod = 'cash') {
    if (btn) { btn.disabled = true; btn.textContent = 'Zpracov√°v√°m...'; }
    console.log('PayAll called for table:', table_number, 'payment method:', paymentMethod);
    
    fetch(API + '?action=get-bill&table=' + table_number)
    .then(r=>r.json())
    .then(res => {
        console.log('Get bill response:', res);
        if (!res.success) {
            throw new Error(res.error || 'Chyba p≈ôi naƒç√≠t√°n√≠ √∫ƒçtu');
        }
        
        const items = res.data.items || [];
        
        if (items.length === 0) {
            if (btn) { btn.disabled = false; btn.textContent = 'ZAPLATIT V≈†E'; }
            loadTables();
            return;
        }

        // Create receipt request for full payment (empty items array means pay all)
        fetch(API + '?action=create-receipt', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({
                table: table_number,
                payment_method: paymentMethod,
                employee_name: 'Admin', // Default employee name
                print: true,
                items: [] // Empty items array means pay all outstanding
            })
        })
        .then(r=>r.json())
        .then(res => {
            console.log('Create receipt response:', res);
            if (!res.success) {
                throw new Error(res.error || 'Chyba p≈ôi vytv√°≈ôen√≠ √∫ƒçtenky');
            }
            
            const receiptNumber = res.data.receipt_number || res.data.number;
            alert(`√öƒçtenka #${receiptNumber} vytvo≈ôena a vyti≈°tƒõna.`);
            
            if (btn) { btn.disabled = false; btn.textContent = 'ZAPLATIT V≈†E'; }
            loadTables();
        })
        .catch(error => {
            console.error('Error creating receipt:', error);
            if (btn) { btn.disabled = false; btn.textContent = 'ZAPLATIT V≈†E'; }
            alert('Chyba p≈ôi platbƒõ: ' + error.message);
        });
    })
    .catch(error => {
        console.error('Error loading bill:', error);
        if (btn) { btn.disabled = false; btn.textContent = 'ZAPLATIT V≈†E'; }
        alert('Chyba p≈ôi naƒç√≠t√°n√≠ √∫ƒçtu: ' + error.message);
    });
}
*/

// LEGACY FUNCTION - COMMENTED OUT - REPLACED BY UNIFIED PAYMENT MODAL
/*
function paySplit(table_number, btn) {
    lastSplitTable = table_number;
    // Use get-bill endpoint for receipt functionality
    fetch(API + '?action=get-bill&table=' + table_number)
    .then(r=>r.json())
    .then(res => {
        if (!res.success) {
            alert('Chyba p≈ôi naƒç√≠t√°n√≠ √∫ƒçtu: ' + (res.error || 'Nezn√°m√° chyba'));
            return;
        }
        
        const items = res.data.items || [];
        const outstandingItems = items.filter(item => {
            const outstandingQty = getItemValue(item, 'qty_outstanding', 'outstanding_qty');
            return outstandingQty > 0;
        });
        
        // Store the bill data for receipt functionality
        lastSplitBillData = res.data;
        showSplitModal(outstandingItems, res.data);
    })
    .catch(error => {
        console.error('Error loading bill:', error);
        alert('Chyba p≈ôi naƒç√≠t√°n√≠ √∫ƒçtu: ' + error.message);
    });
}
*/

// NEW UNIFIED PAYMENT MODAL FUNCTION
function showPaymentModal(table_number, btn) {
    lastSplitTable = table_number;
    // Use get-bill endpoint for receipt functionality
    fetch(API + '?action=get-bill&table=' + table_number)
    .then(r=>r.json())
    .then(res => {
        if (!res.success) {
            alert('Chyba p≈ôi naƒç√≠t√°n√≠ √∫ƒçtu: ' + (res.error || 'Nezn√°m√° chyba'));
            return;
        }
        
        const items = res.data.items || [];
        const outstandingItems = items.filter(item => {
            const outstandingQty = getItemValue(item, 'qty_outstanding', 'outstanding_qty');
            return outstandingQty > 0;
        });
        
        // Store the bill data for receipt functionality
        lastSplitBillData = res.data;
        showUnifiedPaymentModal(outstandingItems, res.data);
    })
    .catch(error => {
        console.error('Error loading bill:', error);
        alert('Chyba p≈ôi naƒç√≠t√°n√≠ √∫ƒçtu: ' + error.message);
    });
}

// NEW UNIFIED PAYMENT MODAL WITH AGGREGATION AND PAYMENT TOGGLE
function showUnifiedPaymentModal(outstandingItems, billData) {
    const modalBg = document.getElementById('modal-bg');
    modalBg.style.display = 'flex';

    if (!outstandingItems || outstandingItems.length === 0) {
        modalBg.innerHTML = `
            <div class="modal">
                <h3>V≈°echny polo≈æky jsou zaplaceny</h3>
                <div class="modal-btns">
                    <button class="modal-btn cancel" onclick="closeModal()">ZPƒöT</button>
                </div>
            </div>
        `;
        return;
    }

    // Aggregate identical items (same name and price)
    const aggregatedItems = aggregateItems(outstandingItems);
    const priorReceipts = billData.prior_receipts || [];

    modalBg.innerHTML = `
        <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <h3>üí∞ Platba ‚Äì st≈Øl ${getTableCodeByNumber(lastSplitTable)}</h3>
            
            <!-- Payment Type Toggle -->
            <div style="margin-bottom: 20px; display: flex; justify-content: center; gap: 10px;">
                <button class="payment-toggle-btn active" id="full-payment-btn" onclick="togglePaymentMode('full')">
                    üí∞ Pln√° platba
                </button>
                <button class="payment-toggle-btn" id="partial-payment-btn" onclick="togglePaymentMode('partial')">
                    üîÑ ƒå√°steƒçn√° platba
                </button>
            </div>
            
            <!-- Outstanding Items Section -->
            <div class="receipt-items-section" style="margin-bottom: 20px;">
                <div style="font-size: 1.2em; font-weight: bold; color: #f09819; margin-bottom: 15px; border-bottom: 2px solid #f09819; padding-bottom: 5px;">
                    üçï Nezaplacen√© polo≈æky
                </div>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
                    <thead>
                        <tr>
                            <th style="background: #f8f9fa; font-weight: bold; color: #333; padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd;">Polo≈æka</th>
                            <th style="background: #f8f9fa; font-weight: bold; color: #333; padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd;">Cena/ks</th>
                            <th style="background: #f8f9fa; font-weight: bold; color: #333; padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd;">Zb√Ωv√°</th>
                            <th style="background: #f8f9fa; font-weight: bold; color: #333; padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd;" id="payment-qty-header">K √∫hradƒõ</th>
                            <th style="background: #f8f9fa; font-weight: bold; color: #333; padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd;">ƒå√°stka</th>
                        </tr>
                    </thead>
                    <tbody id="split-items-tbody">
                        ${generateAggregatedItemsHTML(aggregatedItems)}
                    </tbody>
                </table>
            </div>

            <!-- Payment Method Section -->
            <div class="modal-payment-section">
                <div class="modal-payment-label">Vyberte zp≈Øsob platby:</div>
                <div class="modal-payment-options">
                    <label class="modal-payment-option selected" for="split-payment-cash">
                        <input type="radio" id="split-payment-cash" name="split-payment-method" value="cash" checked>
                        <div class="modal-payment-icon">üíµ</div>
                        <div class="modal-payment-text">Hotovost</div>
                    </label>
                    <label class="modal-payment-option" for="split-payment-card">
                        <input type="radio" id="split-payment-card" name="split-payment-method" value="card">
                        <div class="modal-payment-icon">üí≥</div>
                        <div class="modal-payment-text">Karta</div>
                    </label>
                </div>
            </div>

            <!-- Employee Name Section -->
            <div style="margin: 15px 0;">
                <div style="font-weight: bold; margin-bottom: 8px;">üë®‚Äçüíº Jm√©no obsluhy:</div>
                <input type="text" id="split-employee-name" value="" placeholder="Zadejte jm√©no obsluhy" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
            </div>

            <!-- Note: Receipt is always printed, no checkbox needed -->

            <!-- Total Display -->
            <div id="split-total-display" style="background: #ff5858; color: white; padding: 15px; border-radius: 8px; text-align: center; font-size: 1.4em; font-weight: bold; margin: 15px 0;">
                Celkem k √∫hradƒõ: 0 Kƒç
            </div>

            <!-- Receipt History Section -->
            ${generateReceiptHistoryHTML(priorReceipts)}

            <div class="modal-btns">
                <button class="modal-btn" id="split-create-receipt-btn" onclick="confirmUnifiedPay()">ZAPLATIT</button>
                <button class="modal-btn cancel" onclick="closeModal()">ZPƒöT</button>
            </div>
        </div>
    `;

    // Add CSS for payment toggle buttons
    if (!document.getElementById('payment-toggle-styles')) {
        const style = document.createElement('style');
        style.id = 'payment-toggle-styles';
        style.textContent = `
            .payment-toggle-btn {
                padding: 10px 20px;
                border: 2px solid #f09819;
                background: white;
                color: #f09819;
                border-radius: 8px;
                font-weight: bold;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            .payment-toggle-btn.active {
                background: #f09819;
                color: white;
            }
            .payment-toggle-btn:hover {
                background: #ff5858;
                border-color: #ff5858;
                color: white;
            }
        `;
        document.head.appendChild(style);
    }

    // Setup event listeners
    setupPaymentOptionListeners('.modal-payment-option');
    setupQuantityInputListeners();
    
    // Pre-fill employee name from session
    prefillEmployeeName();
    
    // Set initial payment mode to full
    setPaymentMode('full');
    updateUnifiedModalTotals();
}

// NEW unified modal totals calculation
function updateUnifiedModalTotals() {
    const qtyInputs = document.querySelectorAll('.split-qty-input');
    let total = 0;
    
    qtyInputs.forEach((input, index) => {
        const qty = parseInt(input.value) || 0;
        const unitPrice = parseFloat(input.dataset.unitPrice) || 0;
        const amount = qty * unitPrice;
        
        // Update individual item amount display
        const itemTotalSpan = document.getElementById(`item-total-${index}`);
        if (itemTotalSpan) {
            itemTotalSpan.textContent = formatCurrency(amount);
        }
        
        total += amount;
    });
    
    // Update main total display
    const totalDisplay = document.getElementById('split-total-display');
    if (totalDisplay) {
        totalDisplay.textContent = `Celkem k √∫hradƒõ: ${formatCurrency(total)}`;
    }
}
}

function updateModalTotal() {
    // Legacy function - redirect to new implementation
    updateUnifiedModalTotals();
}

async function confirmSplitPay() {
    const createBtn = document.getElementById('split-create-receipt-btn');
    
    try {
        // Show loading state
        createBtn.disabled = true;
        createBtn.textContent = 'VYSTAVUJE SE...';
        
        // Get payment method
        const paymentMethodInput = document.querySelector('input[name="split-payment-method"]:checked');
        const paymentMethod = paymentMethodInput ? paymentMethodInput.value : 'cash';
        
        // Get employee name
        const employeeName = document.getElementById('split-employee-name').value.trim();
        if (!employeeName) {
            throw new Error('Zadejte jm√©no obsluhy!');
        }
        
        // Get print flag
        const printReceipt = document.getElementById('split-print-checkbox').checked;
        
        // Get selected items with quantities from the new interface
        const qtyInputs = document.querySelectorAll('.split-qty-input');
        const items = [];
        let hasAnyQuantity = false;
        
        qtyInputs.forEach(input => {
            const qty = parseInt(input.value) || 0;
            if (qty > 0) {
                hasAnyQuantity = true;
                const itemId = parseInt(input.dataset.itemId);
                items.push({
                    src: "order_item", // Required by API
                    item_id: itemId,
                    pay_qty: qty
                });
            }
        });
        
        // Validation - if no quantities selected, confirm full payment
        if (!hasAnyQuantity) {
            const confirmed = confirm('Nebyla vybr√°na ≈æ√°dn√° konkr√©tn√≠ polo≈æka. Vystavit √∫ƒçtenku na v≈°echny zb√Ωvaj√≠c√≠ polo≈æky?');
            if (!confirmed) {
                throw new Error('Zru≈°eno u≈æivatelem');
            }
            // Empty items array means full payment in the API
            items.length = 0;
        }
        
        // Create receipt request
        const response = await fetch(`${API}?action=create-receipt`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                table: lastSplitTable,
                payment_method: paymentMethod,
                employee_name: employeeName,
                print: printReceipt,
                items: items
            })
        });
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Chyba p≈ôi vytv√°≈ôen√≠ √∫ƒçtenky');
        }
        
        // Success handling
        const receiptNumber = result.data.receipt_number || result.data.number;
        const fullyPaid = result.data.fully_paid;
        
        alert(`√öƒçtenka #${receiptNumber} vytvo≈ôena.`);
        
        if (fullyPaid) {
            // Close modal and reload tables if fully paid
            closeModal();
            loadTables();
        } else {
            // Reload the modal with updated data
            const billResponse = await fetch(`${API}?action=get-bill&table=${lastSplitTable}`);
            const billResult = await billResponse.json();
            
            if (billResult.success) {
                const items = billResult.data.items || [];
                const outstandingItems = items.filter(item => {
                    const outstandingQty = getItemValue(item, 'qty_outstanding', 'outstanding_qty');
                    return outstandingQty > 0;
                });
                
                lastSplitBillData = billResult.data;
                showSplitModal(outstandingItems, billResult.data);
            }
            
            // Also reload tables to update the main view
            loadTables();
        }
        
    } catch (error) {
        console.error('Error creating receipt:', error);
        alert('Chyba p≈ôi vytv√°≈ôen√≠ √∫ƒçtenky: ' + error.message);
        
        // Reset button state
        createBtn.disabled = false;
        createBtn.textContent = 'ZAPLATIT VYBRAN√â';
    }
}

function changeQuantity(groupIdx, change) {
    // Legacy function - no longer used in new receipt modal interface
    console.warn('changeQuantity called - this function is deprecated in the new receipt modal');
}

function updateLastUpdateTime() {
    document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
}

loadTables();
setInterval(loadTables, 7000);

// Glob√°ln√≠ funkce
window.closeModal = closeModal;
// window.confirmSplitPay = confirmSplitPay; // REMOVED - legacy function
window.updateModalTotal = updateModalTotal;
// window.showConfirmModal = showConfirmModal; // REMOVED - legacy function  
// window.confirmPayAll = confirmPayAll; // REMOVED - legacy function
window.changeQuantity = changeQuantity;
// window.paySplit = paySplit; // REMOVED - legacy function
window.showPaymentModal = showPaymentModal;
window.showTableChangeModal = showTableChangeModal;
window.closeTableChangeModal = closeTableChangeModal;
window.selectNewTable = selectNewTable;
window.confirmTableChange = confirmTableChange;
window.reprintReceipt = reprintReceipt;
window.togglePaymentMode = togglePaymentMode;
window.confirmUnifiedPay = confirmUnifiedPay;
// New unified functions
window.updateUnifiedModalTotals = updateUnifiedModalTotals;
window.setPaymentMode = setPaymentMode;
window.showReprintOptions = showReprintOptions;
window.confirmCloseTable = confirmCloseTable;
window.closeTableSession = closeTableSession;
// Promƒõnn√© pro zru≈°en√≠ polo≈æky
let cancelItemIds = [];
let cancelItemData = {};

// Zobrazit modal pro zru≈°en√≠ polo≈æky - p≈ôij√≠m√° objekt m√≠sto jednotliv√Ωch parametr≈Ø
function showCancelItemModal(modalData) {
    console.log('Modal data:', modalData); // Debug
    
    cancelItemData = {
        name: modalData.item_name,
        maxQty: modalData.qty,
        unitPrice: modalData.unit_price,
        ids: modalData.ids,
        allItems: modalData.all_items
    };
    
    // Spoƒç√≠tej, kolik polo≈æek lze zru≈°it (jen nezaplacen√©)
    const cancellableItems = cancelItemData.allItems.filter(item => 
        item.status !== 'paid' && item.status !== 'cancelled'
    );
    
    const cancellableQty = cancellableItems.reduce((sum, item) => 
        sum + parseInt(item.quantity), 0
    );
    
    if (cancellableQty === 0) {
        alert('≈Ω√°dn√© polo≈æky nelze zru≈°it - v≈°echny jsou u≈æ zaplacen√© nebo zru≈°en√©.');
        return;
    }
    
        // Aktualizuj data pro zru≈°iteln√© mno≈æstv√≠
    cancelItemData.maxQty = cancellableQty;
    cancelItemData.cancellableItems = cancellableItems;
    
    document.getElementById('cancelItemName').textContent = modalData.item_name;
    document.getElementById('cancelItemQty').textContent = cancellableQty + '√ó';
    document.getElementById('cancelItemUnitPrice').textContent = modalData.unit_price + ' Kƒç';
    
    // Zobraz statusy v≈°ech polo≈æek
    const statusDisplay = renderStatusBreakdown(cancelItemData.allItems);
    document.getElementById('cancelItemStatus').innerHTML = statusDisplay;
    
    // Nastavit mno≈æstv√≠
    const quantityInput = document.getElementById('cancelQuantityInput');
    quantityInput.value = Math.min(1, cancellableQty);
    quantityInput.max = cancellableQty;
    
    // Aktualizovat tlaƒç√≠tka
    updateCancelQuantityButtons();
    updateCancelTotalPrice();
    
    // Nastavit varov√°n√≠
    const warningText = document.getElementById('cancelWarningText');
    warningText.textContent = 'Pozor! Tato akce je nevratn√°!';
    
    document.getElementById('cancelItemModal').style.display = 'flex';
}

function renderStatusBreakdown(allItems) {
    const statusGroups = {};
    allItems.forEach(item => {
        const status = item.status;
        if (!statusGroups[status]) {
            statusGroups[status] = 0;
        }
        statusGroups[status] += parseInt(item.quantity);
    });
    
    return Object.entries(statusGroups)
        .map(([status, count]) => 
            `<span class="status-indicator ${status}">${count}√ó ${getStatusText(status)}</span>`
        ).join(' ');
}

// Zmƒõnit mno≈æstv√≠ ke zru≈°en√≠
function changeCancelQuantity(change) {
    const input = document.getElementById('cancelQuantityInput');
    let newValue = parseInt(input.value) + change;
    
    if (newValue < 1) newValue = 1;
    if (newValue > cancelItemData.maxQty) newValue = cancelItemData.maxQty;
    
    input.value = newValue;
    updateCancelQuantityButtons();
    updateCancelTotalPrice();
}

function closeCancelItemModal() {
    document.getElementById('cancelItemModal').style.display = 'none';
    cancelItemData = {};
    document.getElementById('cancelReason').value = '';
}

// Aktualizovat tlaƒç√≠tka mno≈æstv√≠
function updateCancelQuantityButtons() {
    const input = document.getElementById('cancelQuantityInput');
    const decreaseBtn = document.getElementById('decreaseBtn');
    const increaseBtn = document.getElementById('increaseBtn');
    
    const currentValue = parseInt(input.value);
    
    decreaseBtn.disabled = currentValue <= 1;
    increaseBtn.disabled = currentValue >= cancelItemData.maxQty;
}

// Aktualizovat celkovou cenu
function updateCancelTotalPrice() {
    const quantity = parseInt(document.getElementById('cancelQuantityInput').value);
    const totalPrice = quantity * cancelItemData.unitPrice;
    document.getElementById('cancelTotalPrice').textContent = totalPrice + ' Kƒç';
}

// Potvrdit zru≈°en√≠ polo≈æky
async function confirmCancelItem() {
    if (!cancelItemData.cancellableItems || cancelItemData.cancellableItems.length === 0) {
        alert('≈Ω√°dn√© polo≈æky k zru≈°en√≠!');
        return;
    }
    
    const quantity = parseInt(document.getElementById('cancelQuantityInput').value);
    const reason = document.getElementById('cancelReason').value.trim();
    
    if (quantity < 1 || quantity > cancelItemData.maxQty) {
        alert('Neplatn√© mno≈æstv√≠!');
        return;
    }
    
    const confirmBtn = document.querySelector('.cancel-item-btn.confirm');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Ru≈°√≠m...';
    
    try {
        // Vyber ID polo≈æek k zru≈°en√≠
        const itemsToCancel = [];
        let remainingToCancel = quantity;
        
        for (const item of cancelItemData.cancellableItems) {
            if (remainingToCancel <= 0) break;
            
            const itemQty = parseInt(item.quantity);
            const cancelFromThis = Math.min(remainingToCancel, itemQty);
            
            itemsToCancel.push({
                id: item.id,
                cancel_qty: cancelFromThis,
                current_qty: itemQty
            });
            
            remainingToCancel -= cancelFromThis;
        }
        
        console.log('Items to cancel:', itemsToCancel); // Debug
        
        const response = await fetch(`${API}?action=cancel-items`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                items_to_cancel: itemsToCancel,
                total_cancel_quantity: quantity,
                reason: reason,
                item_name: cancelItemData.name,
                unit_price: cancelItemData.unitPrice
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(`√öspƒõ≈°nƒõ zru≈°eno ${quantity}√ó ${cancelItemData.name}`);
            
            // Zav≈ôi modal
            document.getElementById('cancelItemModal').style.display = 'none';
            cancelItemData = {};
            document.getElementById('cancelReason').value = '';
            
            loadTables(); // Reload data
        } else {
            alert('Chyba p≈ôi ru≈°en√≠ polo≈æky: ' + (result.error || 'Nezn√°m√° chyba'));
        }
    } catch (error) {
        console.error('Chyba p≈ôi ru≈°en√≠ polo≈æky:', error);
        alert('Chyba p≈ôi ru≈°en√≠ polo≈æky: ' + error.message);
    } finally {
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'ZRU≈†IT POLO≈ΩKU';
    }
}

function getStatusText(status) {
    switch(status) {
        case 'pending': return 'ƒåek√°';
        case 'preparing': return 'P≈ôipravuje se';
        case 'ready': return 'Hotovo';
        case 'delivered': return 'Doruƒçeno';
        case 'paid': return 'Zaplaceno';
        case 'cancelled': return 'Zru≈°eno';
        default: return status;
    }
}

// P≈ôidej glob√°ln√≠ funkce
window.renderStatusBreakdown = renderStatusBreakdown;
window.showCancelItemModal = showCancelItemModal;
window.closeCancelItemModal = closeCancelItemModal;
window.confirmCancelItem = confirmCancelItem;
window.changeCancelQuantity = changeCancelQuantity;
window.getStatusText = getStatusText;
window.getBillItemClass = getBillItemClass;

// Helper function to get item value with fallback (handles API field variability)
function getItemValue(item, primaryKey, fallbackKey, fallbackKey2) {
    if (item[primaryKey] !== undefined) return item[primaryKey];
    if (fallbackKey && item[fallbackKey] !== undefined) return item[fallbackKey];
    if (fallbackKey2 && item[fallbackKey2] !== undefined) return item[fallbackKey2];
    return undefined;
}

// Helper function to get table code by number
function getTableCodeByNumber(tableNumber) {
    const table = tables.find(t => t.table_number == tableNumber);
    return table ? (table.table_code || `St≈Øl ${tableNumber}`) : `St≈Øl ${tableNumber}`;
}

// Helper function to format date/time
function formatDateTime(dateString) {
    if (!dateString) return '-';
    try {
        const date = new Date(dateString);
        return date.toLocaleString('cs-CZ', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return dateString;
    }
}

// Function to aggregate identical items
function aggregateItems(items) {
    const itemMap = new Map();
    
    items.forEach(item => {
        const itemName = getItemValue(item, 'name', 'item_name');
        const unitPrice = parseFloat(getItemValue(item, 'unit_price', 'price')) || 0;
        const outstandingQty = getItemValue(item, 'qty_outstanding', 'outstanding_qty');
        const itemId = getItemValue(item, 'id', 'item_id');
        const note = getItemValue(item, 'note', 'note') || '';
        
        // Create unique key that includes note to differentiate items with same name but different variants
        const key = `${itemName}_${unitPrice}_${note}`;
        
        if (itemMap.has(key)) {
            const existing = itemMap.get(key);
            existing.qty_outstanding += parseInt(outstandingQty);
            existing.ids.push(itemId); // Store all IDs for payment processing
        } else {
            itemMap.set(key, {
                name: itemName,
                unit_price: unitPrice,
                qty_outstanding: parseInt(outstandingQty),
                note: note,
                ids: [itemId],
                aggregated: true
            });
        }
    });
    
    return Array.from(itemMap.values());
}

// Generate HTML for aggregated items
function generateAggregatedItemsHTML(aggregatedItems) {
    return aggregatedItems.map((item, idx) => {
        const outstandingQty = item.qty_outstanding;
        const itemName = item.name;
        const unitPrice = item.unit_price;
        const note = item.note || '';
        const itemIds = item.ids.join(','); // Store multiple IDs for processing
        
        return `
            <tr>
                <td style="padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd;">
                    ${itemName}
                    ${note ? `<br><small style="color: #666; font-style: italic;">${note}</small>` : ''}
                </td>
                <td style="padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd;">${formatCurrency(unitPrice)}</td>
                <td style="padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd;">${outstandingQty}√ó</td>
                <td style="padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd;">
                    <input type="number" class="split-qty-input" min="0" max="${outstandingQty}" value="0" 
                           data-item-ids="${itemIds}" data-unit-price="${unitPrice}" data-index="${idx}"
                           style="width: 60px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; text-align: center;"
                           onchange="updateUnifiedModalTotals()">
                </td>
                <td style="padding: 8px 12px; text-align: left; border-bottom: 1px solid #ddd;">
                    <span class="item-total" id="item-total-${idx}">0 Kƒç</span>
                </td>
            </tr>
        `;
    }).join('');
}

// Payment mode toggle functions
function togglePaymentMode(mode) {
    const fullBtn = document.getElementById('full-payment-btn');
    const partialBtn = document.getElementById('partial-payment-btn');
    
    if (mode === 'full') {
        fullBtn.classList.add('active');
        partialBtn.classList.remove('active');
    } else {
        fullBtn.classList.remove('active');
        partialBtn.classList.add('active');
    }
    
    setPaymentMode(mode);
}

function setPaymentMode(mode) {
    const inputs = document.querySelectorAll('.split-qty-input');
    const header = document.getElementById('payment-qty-header');
    
    if (mode === 'full') {
        // Set all quantities to maximum (full payment)
        inputs.forEach(input => {
            input.value = input.max;
            input.disabled = true;
        });
        if (header) header.textContent = 'Pln√° platba';
    } else {
        // Enable manual quantity selection (partial payment)
        inputs.forEach(input => {
            input.value = 0;
            input.disabled = false;
        });
        if (header) header.textContent = 'K √∫hradƒõ';
    }
    
    updateUnifiedModalTotals();
}

// Pre-fill employee name from localStorage with session fallback
async function prefillEmployeeName() {
    const employeeNameInput = document.getElementById('split-employee-name');
    if (!employeeNameInput) return;
    
    // First try localStorage
    const storedEmployeeName = localStorage.getItem('employee_name');
    if (storedEmployeeName && storedEmployeeName.trim()) {
        employeeNameInput.value = storedEmployeeName.trim();
        return;
    }
    
    // Fallback to session API
    try {
        const response = await fetch('/pizza/api/get-session-user.php');
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.full_name) {
                employeeNameInput.value = data.full_name;
                // Save to localStorage for next time
                localStorage.setItem('employee_name', data.full_name);
            }
        }
    } catch (error) {
        console.log('Could not fetch session user info:', error);
        // Not critical - user can still enter name manually
    }
    
    // Add event listener to save employee name to localStorage when changed
    employeeNameInput.addEventListener('blur', function() {
        const name = this.value.trim();
        if (name) {
            localStorage.setItem('employee_name', name);
        }
    });
}

// New unified payment confirmation function
async function confirmUnifiedPay() {
    const createBtn = document.getElementById('split-create-receipt-btn');
    
    try {
        // Show loading state
        createBtn.disabled = true;
        createBtn.textContent = 'VYSTAVUJE SE...';
        
        // Get payment method
        const paymentMethod = document.querySelector('input[name="split-payment-method"]:checked').value;
        
        // Get employee name
        const employeeName = document.getElementById('split-employee-name').value.trim();
        if (!employeeName) {
            alert('Pros√≠m vypl≈àte jm√©no obsluhy');
            createBtn.disabled = false;
            createBtn.textContent = 'ZAPLATIT';
            return;
        }
        
        // Check if we're in full payment mode
        const isFullPayment = document.getElementById('full-payment-btn').classList.contains('active');
        
        let selectedItems = [];
        
        if (isFullPayment) {
            // Full payment mode: items should be empty array
            selectedItems = [];
        } else {
            // Partial payment mode: collect selected items and quantities
            document.querySelectorAll('.split-qty-input').forEach((input) => {
                const qty = parseInt(input.value) || 0;
                if (qty > 0) {
                    const itemIds = input.dataset.itemIds.split(',');
                    
                    // For aggregated items, distribute quantities across individual IDs
                    const qtyPerItem = Math.floor(qty / itemIds.length);
                    const remainder = qty % itemIds.length;
                    
                    itemIds.forEach((itemId, idIndex) => {
                        const itemQty = qtyPerItem + (idIndex < remainder ? 1 : 0);
                        if (itemQty > 0) {
                            selectedItems.push({
                                src: 'order_item',
                                item_id: parseInt(itemId),
                                pay_qty: itemQty
                            });
                        }
                    });
                }
            });
        }
        
        // For partial payment, validate that we have items selected
        if (!isFullPayment && selectedItems.length === 0) {
            alert('Pros√≠m vyberte alespo≈à jednu polo≈æku k platbƒõ');
            createBtn.disabled = false;
            createBtn.textContent = 'ZAPLATIT';
            return;
        }
        
        // Create receipt payload
        const receiptPayload = {
            table: lastSplitTable,
            payment_method: paymentMethod,
            employee_name: employeeName,
            print: true, // Always print receipts
            doc_type: 'receipt', // Specify document type for printer routing
            items: selectedItems
        };
        
        // Create receipt
        const response = await fetch(API + '?action=create-receipt', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(receiptPayload)
        });
        
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Chyba p≈ôi vytv√°≈ôen√≠ √∫ƒçtenky');
        }
        
        const receiptNumber = result.data.receipt_number || result.data.number;
        alert(`√öƒçtenka #${receiptNumber} byla √∫spƒõ≈°nƒõ vystavena a vyti≈°tƒõna.`);
        
        // Close modal and reload tables
        closeModal();
        
        // Reload bill data to show remaining items if any
        const billResponse = await fetch(API + '?action=get-bill&table=' + lastSplitTable);
        if (billResponse.ok) {
            const billResult = await billResponse.json();
            if (billResult.success) {
                const outstandingItems = (billResult.data.items || []).filter(item => {
                    const outstandingQty = getItemValue(item, 'qty_outstanding', 'outstanding_qty');
                    return outstandingQty > 0;
                });
                
                lastSplitBillData = billResult.data;
                if (outstandingItems.length > 0) {
                    showUnifiedPaymentModal(outstandingItems, billResult.data);
                }
            }
            
            // Also reload tables to update the main view
            loadTables();
        }
        
    } catch (error) {
        console.error('Error creating receipt:', error);
        alert('Chyba p≈ôi vytv√°≈ôen√≠ √∫ƒçtenky: ' + error.message);
        
        // Reset button state
        createBtn.disabled = false;
        createBtn.textContent = 'ZAPLATIT';
    }
}

// Show reprint options for fully paid table
async function showReprintOptions(tableNumber) {
    try {
        // Get the last receipt for this table
        const billResponse = await fetch(API + '?action=get-bill&table=' + tableNumber);
        if (!billResponse.ok) {
            throw new Error('Failed to load bill information');
        }
        
        const billResult = await billResponse.json();
        if (!billResult.success) {
            throw new Error(billResult.error || 'Failed to load bill information');
        }
        
        const priorReceipts = billResult.data.prior_receipts || [];
        if (priorReceipts.length === 0) {
            alert('≈Ω√°dn√© √∫ƒçtenky k doti≈°tƒõn√≠');
            return;
        }
        
        // Get the last receipt
        const lastReceipt = priorReceipts[priorReceipts.length - 1];
        const receiptNumber = lastReceipt.receipt_number;
        
        const confirmed = confirm(`Znovu vytisknout √∫ƒçtenku #${receiptNumber}?`);
        if (confirmed) {
            await reprintReceipt(receiptNumber);
        }
        
    } catch (error) {
        console.error('Error showing reprint options:', error);
        alert('Chyba p≈ôi naƒç√≠t√°n√≠ √∫ƒçtenek: ' + error.message);
    }
}

// Confirm closing fully paid table
function confirmCloseTable(tableNumber, tableCode) {
    const confirmed = confirm(`Opravdu zav≈ô√≠t st≈Øl ${tableCode}?\n\nT√≠m dojde k ukonƒçen√≠ session pro tento st≈Øl.`);
    if (confirmed) {
        closeTableSession(tableNumber);
    }
}

// Close table session (placeholder - would need backend implementation)
async function closeTableSession(tableNumber) {
    try {
        // This would need a backend endpoint to close/cleanup the table session
        console.log('Closing table session for table:', tableNumber);
        alert('Zav√≠r√°n√≠ stol≈Ø zat√≠m nen√≠ implementov√°no na backendu.');
        
        // For now, just reload the tables to refresh the display
        loadTables();
    } catch (error) {
        console.error('Error closing table session:', error);
        alert('Chyba p≈ôi zav√≠r√°n√≠ stolu: ' + error.message);
    }
}

</script>



<!-- Modal pro zru≈°en√≠ polo≈æky -->
<div id="cancelItemModal" class="cancel-item-modal">
    <div class="cancel-item-content">
        <div class="cancel-item-title">‚ö†Ô∏è Zru≈°it polo≈æku</div>
        <div class="cancel-item-info">
            <p><strong>Polo≈æka:</strong> <span id="cancelItemName"></span></p>
            <p><strong>Dostupn√© mno≈æstv√≠:</strong> <span id="cancelItemQty"></span></p>
            <p><strong>Cena za kus:</strong> <span id="cancelItemUnitPrice"></span></p>
            <p><strong>Status:</strong> <span id="cancelItemStatus"></span></p>
        </div>
        
        <div class="quantity-selector">
            <label>Mno≈æstv√≠ ke zru≈°en√≠:</label>
            <div class="quantity-controls">
                <button type="button" onclick="changeCancelQuantity(-1)" id="decreaseBtn">-</button>
                <input type="number" id="cancelQuantityInput" value="1" min="1" readonly>
                <button type="button" onclick="changeCancelQuantity(1)" id="increaseBtn">+</button>
            </div>
        </div>
        
        <div class="cancel-reason">
            <label>D≈Øvod zru≈°en√≠ (voliteln√©):</label>
            <input type="text" id="cancelReason" placeholder="nap≈ô. ≈°patnƒõ objedn√°no, zmƒõna objedn√°vky...">
        </div>
        
        <div style="color: #dc3545; font-weight: bold; text-align: center;">
            <span id="cancelWarningText">Tato akce je nevratn√°!</span><br>
            <span>Celkov√° ƒç√°stka ke zru≈°en√≠: <span id="cancelTotalPrice">0 Kƒç</span></span>
        </div>
        
        <div class="cancel-item-buttons">
            <button class="cancel-item-btn confirm" onclick="confirmCancelItem()">
                ZRU≈†IT POLO≈ΩKU
            </button>
            <button class="cancel-item-btn cancel" onclick="closeCancelItemModal()">
                ZPƒöT
            </button>
        </div>
    </div>
</div>

</body>
</html>