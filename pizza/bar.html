<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Bar - Objednávky</title>
<link rel="stylesheet" href="theme.css">
<style>
.orders-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:18px;margin-bottom:26px;}
.order-card{border-left:4px solid var(--c-warning);padding:18px 18px 20px;}
.order-card.urgent{border-left-color:var(--c-danger);background:linear-gradient(150deg,#3d2a10,#331f08);}
.order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--c-border-soft);}
.table-number{font-size:.85rem;font-weight:600;color:var(--c-warning);display:flex;align-items:center;gap:8px;}
.order-time{font-size:.6rem;color:var(--c-text-dim);letter-spacing:.5px;}
.priority-badge{background:var(--gradient-danger);color:#fff;padding:4px 8px;border-radius:12px;font-size:.55rem;font-weight:600;letter-spacing:.5px;margin-left:10px;}
.last-update{font-size:.6rem;color:var(--c-text-dim);text-align:center;margin-top:14px;}
.btn-ready{background:var(--gradient-warning)!important;color:#2e1600!important;border:none;font-weight:700;}
.btn-ready:hover{filter:brightness(1.05);}
</style>
</head>
<body>
<header class="app-header">
  <h1>🍺 Bar - Všechny objednávky</h1>
  <nav class="nav-links">
    <a href="index.html" class="nav-link" id="nav-obsluha">🏠 Objednávky</a>
    <a href="bar.html" class="nav-link active" id="nav-bar">🍺 Bar</a>
    <a href="serving.html" class="nav-link" id="nav-servirovani">🍽️ Servírování</a>
    <a href="billing.html" class="nav-link" id="nav-uctovani">💰 Účtování</a>
    <a href="historie.html" class="nav-link">📋 Historie</a>
  </nav>
</header>
<div class="container">
  <div class="section-title">Všechny objednávky k přípravě</div>
  <div class="orders-grid" id="ordersContainer"></div>
  <div class="last-update">Poslední aktualizace: <span id="lastUpdate">-</span></div>
</div>
<script>
const API='api/restaurant-api.php';
let items=[];
function loadOrders(){
  fetch(API+'?action=bar-items').then(r=>r.json()).then(res=>{
    items=res.success?res.data.items:[];
    renderOrders();
    updateLast();
  });
}
function markReady(id,name,btn){
  if(btn){btn.disabled=true;btn.textContent='...';}
  fetch(API+'?action=item-status',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({item_id:id,status:'ready'})
  }).then(r=>r.json()).then(result=>{
    if(!result.success && btn){
      btn.disabled=false;btn.textContent='Hotovo';
    }
    loadOrders();
  }).catch(()=>{
    if(btn){btn.disabled=false;btn.textContent='Hotovo';}
  });
}
function renderOrders(){
  const c=document.getElementById('ordersContainer');
  if(!items.length){
    c.innerHTML=`<div class="empty-state"><span class="icon">🍹</span><h3 style="margin:6px 0 8px;font-size:1rem;">Žádné objednávky</h3><p style="margin:0;font-size:.7rem;color:var(--c-text-dim);">Momentálně nic k přípravě</p></div>`;
    return;
  }
  const grouped={};
  items.forEach(o=>{
    const table=o.table_code||o.table_number||'Neznámý';
    if(!grouped[table]) grouped[table]=[];
    grouped[table].push(o);
  });
  const sorted=Object.entries(grouped).sort(([,a],[,b])=>{
    const oldestA=a.reduce((x,y)=>new Date(x.created_at)<new Date(y.created_at)?x:y);
    const oldestB=b.reduce((x,y)=>new Date(x.created_at)<new Date(y.created_at)?x:y);
    return new Date(oldestA.created_at)-new Date(oldestB.created_at);
  });
  c.innerHTML=sorted.map(([table,arr])=>{
    const oldest=arr.reduce((a,b)=>new Date(a.created_at)<new Date(b.created_at)?a:b);
    const mins=oldest.created_at?Math.floor((Date.now()-new Date(oldest.created_at))/60000):0;
    const urgent=mins>15;
    const itemsHTML=arr.map(drink=>{
      const name=drink.item_name||'Nápoj';
      return `<div class="order-item" style="border-left:4px solid var(--c-warning);padding:10px 14px;border-radius:14px;background:#162230;">
        <div style="font-weight:600;font-size:.7rem;margin-bottom:2px;">${name}</div>
        <div style="font-size:.6rem;color:var(--c-text-dim);">${drink.quantity||1}×</div>
        ${drink.note?`<div class="item-note">${drink.note}</div>`:''}
        <div class="item-actions" style="margin-top:6px;display:flex;gap:6px;">
          <button class="btn small btn-ready" onclick="markReady(${drink.id}, '${name.replace(/'/g,"\\'")}', this)">Hotovo</button>
        </div>
      </div>`;
    }).join('');
    return `<div class="card order-card ${urgent?'urgent':''}">
      <div class="order-header">
        <div class="table-number">🍽️ ${table}${mins>20?'<span class="priority-badge">PRIORITA</span>':''}</div>
        <div class="order-time">⏱️ ${mins} min</div>
      </div>
      <div class="order-items" style="display:flex;flex-direction:column;gap:10px;">${itemsHTML}</div>
    </div>`;
  }).join('');
}
function updateLast(){lastUpdate.textContent=new Date().toLocaleTimeString('cs-CZ');}
loadOrders();
setInterval(loadOrders,1500);
</script>
</body>
</html>