<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Obsluha - Restaurace</title>
<link rel="stylesheet" href="theme.css">
<style>
/* Specifick√© dopl≈àky pro str√°nku obsluhy */
.pergolas-container{display:grid;gap:18px;margin-bottom:24px;}
@media (min-width:1025px){.pergolas-container{grid-template-columns:repeat(auto-fit,minmax(340px,1fr));}}
@media (min-width:769px) and (max-width:1024px){.pergolas-container{grid-template-columns:repeat(2,1fr);}}
@media (max-width:768px){.pergolas-container{grid-template-columns:1fr;gap:14px;}}
.pergola-section{display:flex;flex-direction:column;gap:10px;background:linear-gradient(160deg,#212f40,#24344a);border:1px solid var(--c-border);border-radius:22px;padding:14px 16px 18px;position:relative;box-shadow:var(--shadow-sm);overflow:hidden;}
.location-title{font-size:.65rem;font-weight:700;letter-spacing:.9px;text-transform:uppercase;color:var(--c-text-soft);display:flex;align-items:center;justify-content:space-between;gap:14px;background:var(--glass);padding:10px 14px;border-radius:16px;border:1px solid var(--c-border);}
.pergola-count{background:var(--glass-strong);padding:4px 10px 5px;border-radius:30px;font-size:.55rem;letter-spacing:1px;font-weight:600;color:var(--c-text-dim);border:1px solid var(--c-border);}
.tables-grid{display:grid;gap:8px;padding:14px 12px 10px;background:linear-gradient(135deg,#162230,#1c2b3c);border:1px solid var(--c-border);border-radius:18px;position:relative;}
.tables-grid.small{grid-template-columns:repeat(4,1fr);}
.tables-grid.medium{grid-template-columns:repeat(5,1fr);}
.tables-grid.large{grid-template-columns:repeat(4,1fr);}
.tables-grid.sebou{grid-template-columns:repeat(3,1fr);}
.tables-grid.piaggio{grid-template-columns:1fr;max-width:120px;}
@media (max-width:768px){
  .tables-grid.small,.tables-grid.medium,.tables-grid.large,.tables-grid.sebou,.tables-grid.piaggio,.tables-grid.venku{grid-template-columns:repeat(4,1fr);}
}
.table-btn{min-width:52px;min-height:56px;border-radius:16px;border:1px solid var(--c-border);background:linear-gradient(135deg,#eef2ff,#e2e8f0);color:#1e293b;font-size:.66rem;font-weight:700;letter-spacing:.6px;cursor:pointer;transition:var(--trans);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;position:relative;}
.table-btn:hover{transform:translateY(-3px);border-color:var(--c-accent);box-shadow:0 8px 18px -8px rgba(0,0,0,.65);}
.table-btn.occupied{background:linear-gradient(135deg,#dc2626,#b91c1c);color:#fff;border-color:#dc2626;}
.table-btn.to_clean{background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#1e293b;border-color:#f59e0b;}
.table-btn.selected{outline:2px solid var(--c-success);outline-offset:1px;transform:scale(1.05);}
.menu-section{margin:28px 0 26px;}
.menu-section h2{font-size:1.05rem;margin:0 0 14px;font-weight:600;letter-spacing:.7px;}
.menu-items{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;}
.menu-item{background:linear-gradient(160deg,#233247,#1d2938);border:1px solid var(--c-border);border-radius:18px;padding:14px 14px 16px;display:flex;flex-direction:column;gap:8px;position:relative;transition:var(--trans);}
.menu-item:hover{transform:translateY(-4px);border-color:var(--c-accent);}
.item-title{font-weight:600;font-size:.9rem;color:var(--c-text);}
.item-desc{font-size:.65rem;color:var(--c-text-dim);line-height:1.25;min-height:28px;}
.item-price{font-weight:700;color:var(--c-accent-hover);font-size:.8rem;}
.item-note{width:100%;padding:8px 10px;border:1px solid var(--c-border);border-radius:10px;background:#162230;color:var(--c-text-soft);font-size:.65rem;outline:none;}
.item-note:focus{border-color:var(--c-accent);box-shadow:var(--focus-ring);color:var(--c-text);}
.item-controls{display:flex;gap:8px;align-items:center;margin-top:4px;}
.item-btn{background:var(--gradient-accent);color:#fff;border:none;border-radius:12px;padding:8px 14px;font-weight:600;font-size:.65rem;cursor:pointer;transition:var(--trans);}
.item-btn:hover{filter:brightness(1.08);transform:translateY(-2px);}
.cart{background:linear-gradient(155deg,#1f2f44,#23364c);border:1px solid var(--c-border);border-radius:24px;padding:20px 20px 24px;margin:8px 0 30px;}
.cart-title{font-size:.95rem;font-weight:600;margin:0 0 10px;}
.cart-list{list-style:none;padding:0;margin:0 0 10px;display:flex;flex-direction:column;gap:8px;}
.cart-empty{text-align:center;color:var(--c-text-dim);font-size:.65rem;padding:14px;background:var(--glass);border:1px solid var(--c-border);border-radius:14px;}
.cart-item{display:flex;align-items:flex-start;gap:10px;border:1px solid var(--c-border);background:#162230;padding:10px 12px;border-radius:14px;position:relative;}
.cart-item-details{flex:1;display:flex;flex-direction:column;gap:3px;}
.cart-item-name{font-weight:600;font-size:.72rem;color:var(--c-text);}
.cart-item-note{font-size:.6rem;color:var(--c-text-dim);font-style:italic;line-height:1.2;}
.cart-item-qty{font-size:.6rem;font-weight:600;color:var(--c-accent-hover);margin-left:6px;}
.cart-item-total{font-weight:700;font-size:.7rem;color:var(--c-accent-alt);min-width:55px;text-align:right;}
.cart-item button{width:30px;height:30px;font-size:16px;border:1px solid var(--c-border);background:var(--glass);color:var(--c-text-soft);border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--trans);}
.cart-item button:hover{background:var(--glass-strong);color:var(--c-text);border-color:var(--c-accent);}
.cart-item button:last-child{color:var(--c-danger-alt);border-color:#b91c1c;}
.cart-footer{margin-top:14px;display:flex;align-items:center;justify-content:space-between;gap:20px;flex-wrap:wrap;}
.cart-sum{font-size:.8rem;font-weight:700;color:var(--c-text-soft);}
.cart-btn{background:var(--gradient-success);color:#fff;border:none;padding:12px 24px;font-weight:600;font-size:.72rem;border-radius:16px;cursor:pointer;transition:var(--trans);}
.cart-btn:disabled{background:#334155;color:#64748b;cursor:not-allowed;box-shadow:none;}
.order-section{margin:10px 0 6px;background:linear-gradient(155deg,#1e2c3b,#25364b);border:1px solid var(--c-border);border-radius:24px;padding:22px 22px 26px;}
.order-title{font-size:.95rem;font-weight:600;margin:0 0 14px;}
.order-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:10px;}
.order-item{border:1px solid var(--c-border);background:#162230;padding:12px 14px;border-radius:16px;font-size:.65rem;line-height:1.35;}
.order-item.reserved-order{background:linear-gradient(135deg,#202f44,#263b52);border-left:3px solid var(--c-accent);}
.order-status{font-size:.55rem;border-radius:9px;padding:4px 8px;font-weight:600;margin-left:8px;background:var(--glass);color:var(--c-text-soft);border:1px solid var(--c-border);}
.msg,.err{border-radius:16px;padding:14px 16px;text-align:center;font-weight:600;font-size:.65rem;margin:10px 0 6px;}
.msg{background:linear-gradient(135deg,#134e4a,#0f766e);color:#d1fae5;border:1px solid #0d9488;}
.err{background:linear-gradient(135deg,#7f1d1d,#991b1b);color:#fee2e2;border:1px solid #dc2626;}
@media (max-width:650px){
  .container{padding:20px 14px 28px;}
  .menu-items{grid-template-columns:1fr;}
  .menu-item{padding:14px 14px 16px;}
  .cart{padding:18px 16px;}
  .order-section{padding:20px 18px 24px;}
  .pergola-section{padding:14px 14px 18px;}
  .header h1{font-size:1.75rem;}
}
</style>
</head>
<body>
<div class="app-header">
  <h1>üç∑ Vina≈ôstv√≠ St√°vek</h1>
  <div id="userInfo" class="user-badge" style="display:none;">
    <span>üë§ P≈ôihl√°≈°en: <strong id="currentUser"></strong></span>
    <button class="btn-logout" onclick="logout()">Odhl√°sit</button>
  </div>
  <nav class="nav-links">
    <a href="index.html" class="nav-link active" id="nav-obsluha">üè† Objedn√°vky</a>
    <a href="bar.html" class="nav-link" id="nav-bar">üç∫ Bar</a>
    <a href="serving.html" class="nav-link" id="nav-servirovani">üçΩÔ∏è Serv√≠rov√°n√≠</a>
    <a href="billing.html" class="nav-link" id="nav-uctovani">üí∞ √öƒçtov√°n√≠</a>
    <a href="historie.html" class="nav-link">üìã Historie</a>
  </nav>
</div>

<div class="container">
  <div id="msg"></div>

  <div id="printStatus" class="msg-box msg-info" style="display:none;">
    <div id="printMessage"></div>
  </div>

  <div class="section-title">Vyberte st≈Øl</div>
  <div id="tables" class="pergolas-container"></div>

  <div id="cleanTableSection" style="margin-top: 10px; text-align: center; display: none;">
    <button class="item-btn" onclick="markTableAsCleaned()">Oznaƒçit st≈Øl jako uklizen√Ω</button>
  </div>

  <section id="menu">
    <div class="menu-section">
      <h2>Menu Pizzy</h2>
      <div id="pizzaMenu" class="menu-items"></div>
    </div>
    <div class="menu-section">
      <h2>Menu N√°poje</h2>
      <div id="drinkMenu" class="menu-items"></div>
    </div>
  </section>

  <section id="cartSection" class="cart">
    <div class="cart-title">üõí Ko≈°√≠k</div>
    <ul id="cartList" class="cart-list"></ul>
    <div>
      <label for="customerName" style="font-size:.65rem;letter-spacing:.5px;color:var(--c-text-dim);font-weight:600;display:block;margin:4px 0 6px;">Pozn√°mka (jm√©no / telefon / √∫prava):</label>
      <input type="text" id="customerName" class="item-note" placeholder="Nap≈ô. Nov√°k 777123456 bez s√Ωra">
      <small style="color:var(--c-text-dim);font-size:.55rem;">Tato pozn√°mka se vytiskne na l√≠stku.</small>
    </div>
    <div class="cart-footer">
      <span class="cart-sum" id="cartSum"></span>
      <button class="cart-btn" id="cartSubmit" onclick="submitOrder()">Odeslat objedn√°vku</button>
    </div>
  </section>

  <section id="ordersSection" class="order-section">
    <div class="order-title">Aktu√°ln√≠ objedn√°vky u stolu</div>
    <ul id="orderList" class="order-list"></ul>
  </section>
</div>

<!-- Modal pro zad√°n√≠ jm√©na -->
<div id="employeeModal" style="position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.55); display:none; z-index: 1000;">
  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#162230; padding:34px 34px 40px; border-radius:28px; text-align:center; width:92%; max-width:420px;">
    <h3 style="margin:0 0 18px; font-size:1rem; letter-spacing:.6px;">Zadejte sv√© jm√©no</h3>
    <input type="text" id="employeeNameInput" placeholder="Va≈°e jm√©no" style="padding:12px 14px; margin:0 0 16px; width:100%; border:1px solid var(--c-border); border-radius:14px; background:#1f2d3c; color:var(--c-text-soft); outline:none; font-size:.75rem;" />
    <button onclick="saveEmployeeName()" style="padding:13px 20px; background:var(--gradient-accent); color:#fff; border:none; border-radius:16px; cursor:pointer; font-weight:600; font-size:.7rem; width:100%;">Pokraƒçovat</button>
  </div>
</div>

<!-- Modal potvrzen√≠ -->
<div id="confirmOrderModal" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.55); display:none; z-index:1001;">
  <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); background:#162230; padding:30px 30px 36px; border-radius:28px; width:94%; max-width:680px; max-height:90%; overflow-y:auto; box-shadow:var(--shadow-lg); border:1px solid var(--c-border);">
    <h3 style="margin:0 0 20px; color:var(--c-text); text-align:center; font-size:1rem;">Potvrzen√≠ objedn√°vky</h3>
    <div style="background:#1d2c3b; padding:18px; border-radius:18px; border:1px solid var(--c-border); text-align:center; margin-bottom:16px;">
      <strong style="color:var(--c-success); font-size:.9rem;">St≈Øl: <span id="confirmTableNumber"></span></strong>
    </div>
    <div style="margin-bottom:18px;">
      <h4 style="margin:0 0 10px; color:var(--c-text-soft); font-size:.75rem;">Polo≈æky:</h4>
      <div style="border:1px solid var(--c-border); border-radius:16px; overflow:hidden; background:#1b2736;">
        <table style="width:100%; border-collapse:collapse; font-size:.65rem;">
          <thead>
            <tr style="background:#1e2d3d;">
              <th style="padding:10px; text-align:left; border-bottom:1px solid var(--c-border-soft);">Polo≈æka</th>
              <th style="padding:10px; text-align:center; border-bottom:1px solid var(--c-border-soft);">Ks</th>
              <th style="padding:10px; text-align:right; border-bottom:1px solid var(--c-border-soft);">Cena</th>
            </tr>
          </thead>
          <tbody id="confirmOrderItems"></tbody>
        </table>
      </div>
    </div>
    <div style="background:#1d2c3b; padding:14px 16px; border-radius:14px; border:1px solid var(--c-border); margin-bottom:16px; text-align:right; font-size:.7rem; font-weight:600; color:var(--c-text-soft);">
      Celkem: <span id="confirmTotalQty"></span> ks,&nbsp; <span id="confirmTotalPrice"></span> Kƒç
    </div>
    <div style="margin-bottom:16px; font-size:.65rem; color:var(--c-text-dim);">
      <strong style="color:var(--c-text-soft);">Pozn√°mka:</strong>
      <span id="confirmCustomerNote" style="font-style:italic;"></span>
    </div>
    <div style="display:flex; gap:12px; justify-content:center; flex-wrap:wrap;">
      <button id="confirmBackBtn" onclick="closeConfirmModal()" class="btn outline" style="padding:14px 28px;">Zpƒõt</button>
      <button id="confirmSubmitBtn" onclick="confirmAndSendOrder()" class="btn success" style="padding:14px 28px;">Potvrdit a odeslat</button>
    </div>
  </div>
</div>

<script>
const PRINTER_API_URL = `http://${window.location.hostname}/pizza`;
function showPrintStatus(message, type = 'info') {
  const status = document.getElementById('printStatus');
  const messageEl = document.getElementById('printMessage');
  status.className = `msg-box msg-${type==='success'?'success':type==='error'?'error':'info'}`;
  messageEl.textContent = message;
  status.style.display = 'block';
  setTimeout(() => { status.style.display = 'none'; }, 5000);
}
async function sendToPrinter(orderData) {
  try {
    showPrintStatus('üñ®Ô∏è Odes√≠l√°m objedn√°vku na tisk√°rnu...', 'info');
    const response = await fetch(`${API}?action=proxy-print`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(orderData)
    });
    if (response.ok) {
      const result = await response.json();
      if (result.success) {
        showPrintStatus('‚úÖ Objedn√°vka vyti≈°tƒõna!', 'success');
        return true;
      } else {
        showPrintStatus(`‚ùå Chyba tisku: ${result.error||'Nezn√°m√°'}`, 'error');
        return false;
      }
    } else {
      showPrintStatus(`‚ùå Chyba p≈ôipojen√≠ (HTTP ${response.status})`, 'error');
      return false;
    }
  } catch(e){
    showPrintStatus('‚ùå Nelze kontaktovat tisk√°rnu', 'error');
    return false;
  }
}
function logout() {
  if (confirm('Opravdu se chcete odhl√°sit?')) {
    localStorage.removeItem('employee_name');
    localStorage.removeItem('employee_id');
    location.reload();
  }
}
function checkEmployeeName() {
  const employeeName = localStorage.getItem('employee_name');
  if (!employeeName) showEmployeeModal(); else updateUserInfo();
}
function saveEmployeeName() {
  const input = document.getElementById('employeeNameInput');
  const name = input.value.trim();
  if (name) {
    localStorage.setItem('employee_name', name);
    hideEmployeeModal();
    updateUserInfo();
  }
}
function updateUserInfo() {
  const employeeName = localStorage.getItem('employee_name');
  const userInfo = document.getElementById('userInfo');
  const currentUser = document.getElementById('currentUser');
  if (employeeName) { currentUser.textContent = employeeName; userInfo.style.display = 'flex'; }
  else userInfo.style.display='none';
}
function showEmployeeModal(){employeeModal.style.display='block';}
function hideEmployeeModal(){employeeModal.style.display='none';}

const API='api/restaurant-api.php';
let tables=[], pizzas=[], drinks=[], selectedTable=null, cart=[], orders=[];

function clearCart(){
  cart=[];
  customerName.value='';
  renderCart();
}
function showMsg(msg,good=true){
  msg? (document.getElementById('msg').innerHTML=`<div class="${good?'msg':'err'}">${msg}</div>`):
       (document.getElementById('msg').innerHTML='');
}
function api(action,data={},method='GET'){
  let url=API+'?action='+action;
  if(method==='GET' && Object.keys(data).length){
    url+='&'+new URLSearchParams(data);
    return fetch(url).then(r=>r.json());
  }
  return fetch(url,{
    method,
    headers:{'Content-Type':'application/json'},
    body:method==='GET'?null:JSON.stringify(data)
  }).then(r=>r.json());
}

function selectTable(tableNumber){
  selectedTable=tableNumber;
  renderTables();
  renderCart();
  refreshOrders();
  showCleanTableButton();
  showMsg('');
}
function refreshTables(){
  api('tables').then(res=>{
    tables=res.success?res.data.tables:[];
    renderTables();
  });
}
function renderTables(){
  const el=document.getElementById('tables');
  el.innerHTML='';
  const pergolOrder=[
    { name:'üç∑ Terasa', key:'Terasa', tables:['1','2'], cssClass:'terasa small'},
    { name:'üçá Zahrada', key:'Zahrada', tables:['3','4'], cssClass:'zahrada small'},
    { name:'üçæ Skl√≠pek', key:'Skl√≠pek', tables:['5','6'], cssClass:'sklipek small'},
    { name:'ü•Ç Dvorek', key:'Dvorek', tables:['7','8','9'], cssClass:'dvorek small'},
    { name:'üì¶ Sebou', key:'Sebou', tables:['S1','S2','S3','S4','S5','S6','S7','S8','S9'], cssClass:'sebou sebou'}
  ];
  const locationGroups={};
  tables.forEach(t=>{
    const ln=t.location_name||t.location||'Auto';
    if(!locationGroups[ln]) locationGroups[ln]=[];
    locationGroups[ln].push(t);
  });
  pergolOrder.forEach(pergola=>{
    const locationTables=locationGroups[pergola.key]||[];
    if(!locationTables.length) return;
    const section=document.createElement('div');
    section.className='pergola-section';
    const title=document.createElement('div');
    title.className='location-title';
    title.innerHTML=`<div>${pergola.name}</div><div class="pergola-count">${locationTables.length} ks</div>`;
    section.appendChild(title);
    const grid=document.createElement('div');
    grid.className='tables-grid '+pergola.cssClass;
    const sorted=pergola.tables.map(c=>locationTables.find(t=>t.table_code===c)).filter(Boolean);
    const remaining=locationTables.filter(t=>!pergola.tables.includes(t.table_code));
    const all=[...sorted,...remaining];
    all.forEach(t=>{
      let cls='table-btn';
      if(t.status==='occupied') cls+=' occupied';
      if(t.status==='to_clean') cls+=' to_clean';
      let style='';
      if(String(selectedTable)===String(t.table_number)) style='outline:2px solid #10b981;outline-offset:1px;transform:scale(1.03);';
      const b=document.createElement('button');
      b.className=cls;
      b.style.cssText=style;
      b.onclick=()=>selectTable(t.table_number);
      const emoji=(key)=>{
        if(key.includes('Pergola')) return 'üåø';
        if(key==='Olivy') return 'ü´í';
        if(key==='Auto') return 'üöó';
        if(key==='PIAGGIO') return 'üõµ';
        if(key==='Sebou') return 'üì¶';
        if(key==='VENKU') return 'üå§Ô∏è';
        return '';
      };
      b.innerHTML=`<div style="font-size:.55em;opacity:.45;">${emoji(pergola.key)}</div><div>${t.table_code}</div>`;
      grid.appendChild(b);
    });
    section.appendChild(grid);
    el.appendChild(section);
  });
}
function refreshMenu(){
  Promise.all([api('pizza-categories'),api('drink-categories')]).then(([fc,dc])=>{
    let cats=[];
    if(fc.success) cats=[...cats,...fc.data.categories];
    if(dc.success) cats=[...cats,...dc.data.categories];
    Promise.all([api('pizza-menu'),api('drink-menu')]).then(([fm,dm])=>{
      if(fm.success) pizzas=fm.data.pizzas;
      if(dm.success) drinks=dm.data.drinks;
      const sorted=sortCategories(cats);
      renderCategoryMenus(sorted);
    });
  });
}
function renderCategoryMenus(categories){
  const menuSection=document.getElementById('menu');
  menuSection.innerHTML='';
  categories.forEach(category=>{
    const categoryId=category.replace(/[^a-zA-Z0-9]/g,'')+'Menu';
    const categoryPizzas=pizzas.filter(i=>i.category===category);
    const categoryDrinks=drinks.filter(i=>i.category===category);
    const sortItems=items=>items.sort((a,b)=>{
      const numA=parseInt(a.type.match(/\d+/)||[0]);
      const numB=parseInt(b.type.match(/\d+/)||[0]);
      return numA-numB;
    });
    const sp=sortItems(categoryPizzas);
    const sd=sortItems(categoryDrinks);
    const all=[...sp,...sd];
    if(all.length){
      const wrap=document.createElement('div');
      wrap.className='menu-section';
      wrap.innerHTML=`<h2>Menu ${category}</h2><div id="${categoryId}" class="menu-items"></div>`;
      menuSection.appendChild(wrap);
      renderMenu(categoryId,all,sp.length>0?'pizza':'drink');
    }
  });
}
function sortCategories(c){
  const pr={'Predkrm':1,'Pizza':2,'Pasta':3,'Dezert':4,'Negroni':5,'Spritz':6,'Koktejl':7,'Digestiv':8,'Vino':9,'Pivo':10,'Nealko':11};
  return [...new Set(c)].sort((a,b)=>(pr[a]||999)-(pr[b]||999));
}
function renderMenu(id,items,type){
  const el=document.getElementById(id);
  if(!el) return;
  if(!items.length){
    el.innerHTML='<div>≈Ω√°dn√© polo≈æky.</div>';
    return;
  }
  el.innerHTML='';
  items.forEach(item=>{
    const d=document.createElement('div');
    d.className='menu-item';
    d.innerHTML=`<div class="item-title">${item.name}</div>
    <div class="item-desc">${item.description||''}</div>
    <div class="item-price">${item.price} Kƒç</div>
    <input placeholder="Pozn√°mka (nap≈ô. bez s√Ωra)" class="item-note" id="${type}-note-${item.id}">
    <div class="item-controls"><button class="item-btn" onclick="addToCart('${type}','${item.id}')">P≈ôidat</button></div>`;
    el.appendChild(d);
  });
}
function addToCart(type,id){
  const list=type==='pizza'?pizzas:drinks;
  const item=list.find(x=>x.id==id);
  if(!item) return;
  const note=document.getElementById(`${type}-note-${item.id}`).value.trim();
  let itemType=item.category||type;
  if(/^pizza$/i.test(itemType)) itemType='pizza';
  else if(/^pasta$/i.test(itemType)) itemType='pasta';
  else if(/^predkrm$/i.test(itemType)) itemType='predkrm';
  else if(/^dezert$/i.test(itemType)) itemType='dezert';
  let existing=cart.find(c=>c.type===itemType&&c.id==id&&c.note===note);
  if(existing) existing.qty++;
  else cart.push({type:itemType,id,name:item.name,price:item.price,qty:1,note});
  renderCart();
  document.getElementById(`${type}-note-${item.id}`).value='';
}
function renderCart(){
  const el=document.getElementById('cartList');
  if(!cart.length){
    el.innerHTML='<li class="cart-empty">Ko≈°√≠k je pr√°zdn√Ω</li>';
  }else{
    el.innerHTML='';
    cart.forEach((item,idx)=>{
      el.innerHTML+=`<li class="cart-item">
        <div class="cart-item-details">
          <span class="cart-item-name">${item.name}</span>
          <span class="cart-item-qty">${item.qty}√ó</span>
          ${item.note?`<div class="cart-item-note">üìù ${item.note}</div>`:''}
        </div>
        <div class="cart-item-total">${item.price*item.qty} Kƒç</div>
        <button onclick="changeQty(${idx},-1)">‚àí</button>
        <button onclick="changeQty(${idx},1)">+</button>
        <button onclick="removeCart(${idx})">‚úñ</button>
      </li>`;
    });
  }
  const sum=cart.reduce((s,x)=>s+x.price*x.qty,0);
  cartSum.textContent='Celkem: '+sum+' Kƒç';
  cartSubmit.disabled=!cart.length||!selectedTable;
}
function changeQty(idx,delta){
  cart[idx].qty+=delta;
  if(cart[idx].qty<1) cart.splice(idx,1);
  renderCart();
}
function removeCart(idx){
  cart.splice(idx,1);
  renderCart();
}
function submitOrder(){openConfirmModal();}
function openConfirmModal(){
  if(!cart.length||!selectedTable) return;
  populateConfirmModal();
  confirmOrderModal.style.display='block';
}
function populateConfirmModal(){
  const table=tables.find(t=>t.table_number==selectedTable);
  const code=table?table.table_code:`St≈Øl ${selectedTable}`;
  confirmTableNumber.textContent=code;
  const aggregated={};
  cart.forEach(item=>{
    const key=`${item.name}_${item.price}_${item.note||''}`;
    if(aggregated[key]) aggregated[key].qty+=item.qty;
    else aggregated[key]={name:item.name,price:item.price,qty:item.qty,note:item.note};
  });
  confirmOrderItems.innerHTML='';
  let totalQty=0,totalPrice=0;
  Object.values(aggregated).forEach(it=>{
    totalQty+=it.qty;
    const line=it.price*it.qty;
    totalPrice+=line;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td style="padding:8px 10px;border-bottom:1px solid #243447;">
      ${escapeHtml(it.name)}${it.note?`<br><small style="color:#64748b;">üìù ${escapeHtml(it.note)}</small>`:''}</td>
      <td style="padding:8px 10px;text-align:center;border-bottom:1px solid #243447;">${it.qty}</td>
      <td style="padding:8px 10px;text-align:right;border-bottom:1px solid #243447;">${line} Kƒç</td>`;
    confirmOrderItems.appendChild(tr);
  });
  confirmTotalQty.textContent=totalQty;
  confirmTotalPrice.textContent=totalPrice;
  const note=customerName.value.trim();
  confirmCustomerNote.textContent=(note||'(bez pozn√°mky)').slice(0,120);
}
function closeConfirmModal(){confirmOrderModal.style.display='none';}
function escapeHtml(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}
async function confirmAndSendOrder(){
  if(!cart.length||!selectedTable) return;
  const customerNameVal=customerName.value;
  const items=[];
  cart.forEach(it=>{
    for(let i=0;i<it.qty;i++){
      items.push({type:it.type,name:it.name,quantity:1,unit_price:it.price,note:it.note});
    }
  });
  const back=confirmBackBtn;
  const submit=confirmSubmitBtn;
  const backTxt=back.textContent;
  const submitTxt=submit.textContent;
  back.disabled=true;submit.disabled=true;submit.textContent='Odes√≠l√°m...';
  const backup=[...cart];
  showMsg('üîÑ Odes√≠l√°m objedn√°vku...');
  let created=false;
  try{
    const resp=await fetch(API+'?action=add-order',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        table:selectedTable,
        items,
        customer_name:customerNameVal,
        employee_name:localStorage.getItem('employee_name')
      })
    });
    if(!resp.ok) throw new Error('HTTP '+resp.status);
    let data;
    const txt=await resp.text();
    try{data=JSON.parse(txt);}catch(e){throw new Error('Neplatn√° JSON odpovƒõƒè');}
    const orderId=data.data?.order_id;
    if(orderId){
      created=true;
      clearCart();
      data.success?showMsg('‚úÖ Objedn√°vka odesl√°na!'):showMsg('‚ö†Ô∏è Ulo≈æeno s varov√°n√≠m: '+(data.error||''),false);
      const kitchen=items.filter(i=>['pizza','pasta','predkrm','dezert'].includes(i.type));
      if(kitchen.length){
        const tableObj=tables.find(t=>t.table_number==selectedTable);
        const code=tableObj?tableObj.table_code:`St≈Øl ${selectedTable}`;
        const printData={
          order_id:orderId,
          table_code:code,
          employee_name:localStorage.getItem('employee_name')||'Nezn√°m√Ω',
          customer_name:customerNameVal||'',
          created_at:new Date().toISOString(),
          items:kitchen.map(i=>({quantity:i.quantity,item_name:i.name,note:i.note||''}))
        };
        sendToPrinter(printData).then(ok=>{
          if(ok) showMsg('‚úÖ Objedn√°vka odesl√°na a vyti≈°tƒõna!');
          else showMsg('‚ö†Ô∏è Odesl√°no, tisk selhal.',false);
        });
      }
      refreshOrders();
      refreshTables();
      closeConfirmModal();
    }else{
      showMsg(data.error||'Chyba p≈ôi vytv√°≈ôen√≠ objedn√°vky',false);
    }
  }catch(e){
    if(!created && backup.length){
      cart=[...backup];
      renderCart();
    }
    showMsg('Chyba: '+e.message,false);
  }finally{
    back.disabled=false; submit.disabled=false;
    back.textContent=backTxt; submit.textContent=submitTxt;
  }
}
function refreshOrders(){
  if(!selectedTable) return;
  api('table-orders',{table_number:selectedTable}).then(res=>{
    orders=res.success?res.data.orders:[];
    renderOrders();
  });
}
function renderOrders(){
  const el=document.getElementById('orderList');
  if(!orders.length){
    el.innerHTML='<li class="cart-empty" style="background:#162230;">≈Ω√°dn√© objedn√°vky.</li>';
    return;
  }
  el.innerHTML='';
  orders.forEach(order=>{
    let statusText=order.status;
    let statusStyle='';
    const allDelivered=order.items.every(i=>i.status==='delivered');
    if(allDelivered){statusText='Doruƒçeno'; statusStyle='background:#6ee7b7;color:#064e3b;';}
    else {statusText='Doruƒçov√°na'; statusStyle='background:#dc2626;color:#fff;';}
    const isReserved=order.is_reserved==='1'||order.is_reserved===1||order.is_reserved===true;
    const resBadge=isReserved?'<span style="background:var(--c-accent);color:#fff;padding:3px 8px;border-radius:14px;font-size:.55rem;">üìÖ REZERVACE</span>':'';
    el.innerHTML+=`<li class="order-item${isReserved?' reserved-order':''}">
      <div style="font-weight:600;font-size:.7rem;">
        Objedn√°vka #${order.id} ${resBadge}
        <span class="order-status" style="${statusStyle}">${statusText}</span>
      </div>
      <div style="margin-top:6px;font-size:.62rem;line-height:1.35;">
        ${order.items.map(it=>`${it.item_name} (${it.quantity}√ó, ${it.unit_price} Kƒç)${it.note?` <span class="order-note">üìù ${it.note}</span>`:''}`).join('<br>')}
      </div>
    </li>`;
  });
}
function showCleanTableButton(){
  const section=document.getElementById('cleanTableSection');
  if(!selectedTable){section.style.display='none';return;}
  const table=tables.find(t=>parseInt(t.table_number)===selectedTable);
  if(table && table.status==='to_clean') section.style.display='block';
  else section.style.display='none';
}
function markTableAsCleaned(){
  fetch(API+'?action=mark-table-as-cleaned',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({table_number:selectedTable})
  }).then(r=>r.json()).then(res=>{
    if(res.success){
      showMsg('St≈Øl oznaƒçen jako uklizen√Ω.');
      refreshTables();
      showCleanTableButton();
      refreshOrders();
    }else showMsg(res.error,false);
  });
}
function loop(){
  refreshTables();
  if(selectedTable) refreshOrders();
  setTimeout(loop,6000);
}
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    if(confirmOrderModal.style.display==='block') closeConfirmModal();
  }
});
checkEmployeeName();
refreshTables();
refreshMenu();
renderCart();
setTimeout(loop,6000);
</script>
</body>
</html>