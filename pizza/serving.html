<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Servírování - Vydání objednávek</title>
<link rel="stylesheet" href="theme.css">
<style>
.orders-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:18px;margin-bottom:26px;}
.order-card{border-left:4px solid var(--c-accent);padding:18px 18px 20px;}
.order-card.urgent{border-left-color:var(--c-warning);background:linear-gradient(150deg,#2d2814,#2a250f);}
.order-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--c-border-soft);}
.table-number{font-size:.85rem;font-weight:600;color:var(--c-accent-hover);display:flex;align-items:center;gap:8px;}
.order-time{font-size:.6rem;color:var(--c-text-dim);letter-spacing:.5px;}
.last-update{font-size:.6rem;color:var(--c-text-dim);text-align:center;letter-spacing:.5px;margin-top:14px;}
.btn-ready{background:var(--gradient-success)!important;color:#fff!important;border:none;}
.btn-ready:hover{filter:brightness(1.08);}
.btn-reklamace{background:var(--gradient-danger)!important;color:#fff!important;border:none;}
.btn-reklamace:hover{filter:brightness(1.05);}
</style>
</head>
<body>
<header class="app-header">
  <h1>🍽️ Servírování</h1>
  <nav class="nav-links">
    <a href="index.html" class="nav-link" id="nav-obsluha">🏠 Objednávky</a>
    <a href="bar.html" class="nav-link" id="nav-bar">🍺 Bar</a>
    <a href="serving.html" class="nav-link active" id="nav-servirovani">🍽️ Servírování</a>
    <a href="billing.html" class="nav-link" id="nav-uctovani">💰 Účtování</a>
    <a href="historie.html" class="nav-link">📋 Historie</a>
  </nav>
</header>
<div class="container">
  <div class="section-title">Vydávejte hotové objednávky</div>
  <div class="orders-grid" id="ordersContainer"></div>
  <div class="last-update">Poslední aktualizace: <span id="lastUpdate">-</span></div>
</div>
<script>
const API='api/restaurant-api.php';
let items=[];
function showToast(msg,color='#6366f1'){
  const t=document.createElement('div');
  t.className='toast';
  t.style.background=color.startsWith('linear')?color:color;
  t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';setTimeout(()=>t.remove(),400);},2600);
}
function loadOrders(){
  fetch(API+'?action=ready-items').then(r=>r.json()).then(res=>{
    items=res.success?res.data.items:[];
    renderOrders();
    updateLast();
  }).catch(()=>showToast('Chyba načítání','var(--gradient-danger)'));
}
function markDelivered(id,name,btn){
  if(btn){btn.disabled=true;btn.textContent='Označuji...';}
  fetch(API+'?action=item-status',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({item_id:id,status:'delivered'})
  }).then(r=>r.json()).then(res=>{
    if(res.success) showToast(`Vydáno: ${name}`,'var(--gradient-success)');
    else showToast(res.error||'Chyba','var(--gradient-danger)');
    loadOrders();
  }).catch(()=>{showToast('Chyba API','var(--gradient-danger)');loadOrders();});
}
function returnToKitchen(id,name,btn){
  if(btn){btn.disabled=true;btn.textContent='Reklamuji...';}
  fetch(API+'?action=item-status',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({item_id:id,status:'pending',note:'Reklamace'})
  }).then(r=>r.json()).then(res=>{
    if(res.success) showToast(`Vráceno: ${name}`,'var(--gradient-danger)');
    else showToast(res.error||'Chyba reklamace','var(--gradient-danger)');
    loadOrders();
  }).catch(()=>{showToast('Chyba API','var(--gradient-danger)');loadOrders();});
}
function renderOrders(){
  const c=document.getElementById('ordersContainer');
  if(!items.length){
    c.innerHTML=`<div class="empty-state"><span class="icon">🍽️</span><h3 style="margin:6px 0 8px;font-size:1rem;">Žádné hotové položky</h3><p style="margin:0;font-size:.7rem;color:var(--c-text-dim);letter-spacing:.4px;">Momentálně nic k vydání</p></div>`;
    return;
  }
  const grouped={};
  items.forEach(o=>{
    const table=o.table_code||o.table_number||'Neznámý';
    if(!grouped[table]) grouped[table]=[];
    grouped[table].push(o);
  });
  c.innerHTML=Object.entries(grouped).map(([table,arr])=>{
    const oldest=arr.reduce((a,b)=>new Date(a.created_at)<new Date(b.created_at)?a:b);
    const mins=Math.floor((Date.now()-new Date(oldest.created_at))/60000);
    const urgent=mins>15;
    const body=arr.map(it=>{
      const name=it.item_name||'Položka';
      return `<div class="order-item">
        <div style="font-weight:600;font-size:.7rem;margin-bottom:2px;">${name}</div>
        <div style="font-size:.6rem;color:var(--c-text-dim);">${it.quantity||1}×</div>
        ${it.note?`<div class="item-note">${it.note}</div>`:''}
        <div class="item-actions" style="display:flex;gap:6px;margin-top:6px;">
          <button class="btn small btn-ready" onclick="markDelivered(${it.id}, '${name.replace(/'/g,"\\'")}', this)">Vydáno</button>
          <button class="btn small btn-reklamace" onclick="returnToKitchen(${it.id}, '${name.replace(/'/g,"\\'")}', this)">Reklamace</button>
        </div>
      </div>`;
    }).join('');
    return `<div class="card order-card ${urgent?'urgent':''}">
      <div class="order-header">
        <div class="table-number">🍽️ Stůl ${table}</div>
        <div class="order-time">⏱️ ${mins} min</div>
      </div>
      <div class="order-items" style="display:flex;flex-direction:column;gap:10px;">${body}</div>
    </div>`;
  }).join('');
}
function updateLast(){lastUpdate.textContent=new Date().toLocaleTimeString('cs-CZ');}
loadOrders();
setInterval(loadOrders,8000);
</script>
</body>
</html>