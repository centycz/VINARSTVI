<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Historie √∫ƒçtenek</title>
<link rel="stylesheet" href="theme.css">
<style>
.history-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:18px;}
.rc-meta{display:grid;grid-template-columns:1fr 1fr;gap:4px 10px;font-size:.63rem;color:var(--c-text-dim);}
.rc-meta div{display:flex;justify-content:space-between;gap:6px;}
.preview-bg{position:fixed;inset:0;background:rgba(10,16,25,.78);backdrop-filter:blur(10px) saturate(160%);display:none;align-items:center;justify-content:center;z-index:1600;padding:30px;}
.preview-modal{background:linear-gradient(150deg,#1d2838,#223248);border:1px solid var(--c-border);border-radius:30px;box-shadow:var(--shadow-lg),0 0 0 1px rgba(255,255,255,.05);width:100%;max-width:560px;max-height:94vh;display:flex;flex-direction:column;overflow:hidden;}
.pm-header{padding:16px 24px;background:linear-gradient(135deg,#27354a,#2c415b);color:#fff;font-weight:600;font-size:.8rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--c-border-soft);}
.pm-body{padding:20px 24px;overflow:auto;font-size:.7rem;color:var(--c-text-soft);line-height:1.35;}
.pm-footer{padding:16px 24px;display:flex;justify-content:flex-end;gap:10px;background:#1b2739;border-top:1px solid var(--c-border-soft);}
.receipt-items{margin:12px 0 4px;border-top:1px solid var(--c-border);border-bottom:1px solid var(--c-border);padding:4px 0;}
.receipt-items-row{display:flex;justify-content:space-between;align-items:flex-start;padding:6px 0;border-bottom:1px dashed var(--c-border-soft);font-size:.62rem;}
.receipt-items-row:last-child{border-bottom:none;}
.r-name{font-weight:600;color:var(--c-text);max-width:220px;}
.r-note{font-size:.55rem;color:var(--c-text-dim);font-style:italic;display:block;margin-top:2px;}
.r-qty{color:var(--c-accent-hover);font-weight:600;margin:0 10px;font-size:.6rem;}
.r-price{font-weight:600;color:var(--c-accent-alt);min-width:70px;text-align:right;}
.total-line{margin-top:10px;font-weight:700;text-align:right;color:var(--c-accent);font-size:.7rem;}
.badge-floating.reprint{background:var(--gradient-warning);color:#2e1600;}
@media(max-width:760px){.rc-meta{grid-template-columns:1fr;}}
</style>
</head>
<body>
<header class="app-header">
  <h1>üìã Historie √∫ƒçtenek</h1>
  <nav class="nav-links">
    <a href="index.html" class="nav-link">üè† Objedn√°vky</a>
    <a href="bar.html" class="nav-link">üç∫ Bar</a>
    <a href="serving.html" class="nav-link">üçΩÔ∏è Serv√≠rov√°n√≠</a>
    <a href="billing.html" class="nav-link">üí∞ √öƒçtov√°n√≠</a>
    <a href="historie.html" class="nav-link active">üìã Historie</a>
  </nav>
</header>

<div class="container">
  <div class="section-title">Filtry</div>
  <div class="grid" style="gap:16px;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));margin-bottom:24px;">
    <label style="display:flex;flex-direction:column;gap:6px;font-size:.65rem;">
      <span style="font-weight:600;letter-spacing:.6px;color:var(--c-text-dim);">Datum od</span>
      <input type="date" id="dateFrom">
    </label>
    <label style="display:flex;flex-direction:column;gap:6px;font-size:.65rem;">
      <span style="font-weight:600;letter-spacing:.6px;color:var(--c-text-dim);">Datum do</span>
      <input type="date" id="dateTo">
    </label>
    <label style="display:flex;flex-direction:column;gap:6px;font-size:.65rem;">
      <span style="font-weight:600;letter-spacing:.6px;color:var(--c-text-dim);">St≈Øl</span>
      <select id="tableFilter"><option value="">V≈°echny</option></select>
    </label>
    <label style="display:flex;flex-direction:column;gap:6px;font-size:.65rem;">
      <span style="font-weight:600;letter-spacing:.6px;color:var(--c-text-dim);">Obsluha</span>
      <select id="employeeFilter"><option value="">V≈°ichni</option></select>
    </label>
    <div style="display:flex;align-items:flex-end;">
      <button class="btn primary" style="height:40px;" onclick="loadReceipts()">üîç Hledat</button>
    </div>
  </div>

  <div class="section-title">√öƒçtenky</div>
  <div id="historyContainer" class="history-grid">
    <div class="empty-state">Naƒç√≠t√°n√≠...</div>
  </div>
  <div style="text-align:center;font-size:.6rem;margin-top:26px;color:var(--c-text-dim);letter-spacing:.6px;">
    Posledn√≠ aktualizace: <span id="lastUpdate">-</span>
  </div>
</div>

<div id="previewBg" class="preview-bg" onclick="if(event.target.id==='previewBg'){closeReceiptPreview();}">
  <div class="preview-modal" id="previewModal" style="display:none">
    <div class="pm-header">
      <span id="previewTitle">√öƒçtenka</span>
      <button class="btn small outline" onclick="closeReceiptPreview()">‚úñ</button>
    </div>
    <div class="pm-body" id="previewBody"></div>
    <div class="pm-footer">
      <button class="btn outline" onclick="closeReceiptPreview()">Zav≈ô√≠t</button>
      <button class="btn success" id="previewReprintBtn">Reprint</button>
    </div>
  </div>
</div>

<script>
const API='api/restaurant-api.php';
let receipts=[];
function formatCZK(v){return new Intl.NumberFormat('cs-CZ',{style:'currency',currency:'CZK',minimumFractionDigits:0}).format(v||0);}
function setDatesInit(){
  const to=new Date();
  const from=new Date(); from.setDate(to.getDate()-7);
  dateTo.value=to.toISOString().slice(0,10);
  dateFrom.value=from.toISOString().slice(0,10);
}
function updateLast(){lastUpdate.textContent=new Date().toLocaleTimeString('cs-CZ');}
async function loadFilters(){
  try{
    const t=await fetch(`${API}?action=tables`).then(r=>r.json());
    if(t.success) t.data.tables.forEach(tb=>{
      const o=document.createElement('option');o.value=tb.table_number;o.textContent=tb.table_code||'St≈Øl '+tb.table_number;tableFilter.appendChild(o);
    });
  }catch(e){}
  try{
    const e=await fetch(`${API}?action=employees-list`).then(r=>r.json());
    if(e.success) e.data.employees.forEach(emp=>{
      const o=document.createElement('option');o.value=emp.name;o.textContent=`${emp.name} (${emp.receipt_count||emp.order_count||emp.count||0} √∫ƒçt.)`;employeeFilter.appendChild(o);
    });
  }catch(e){}
}
async function loadReceipts(){
  historyContainer.innerHTML='<div class="empty-state">Naƒç√≠t√°n√≠...</div>';
  const params=new URLSearchParams({action:'receipts-history',date_from:dateFrom.value,date_to:dateTo.value});
  if(tableFilter.value) params.append('table_number',tableFilter.value);
  if(employeeFilter.value) params.append('employee_name',employeeFilter.value);
  try{
    const res=await fetch(`${API}?${params}`).then(r=>r.json());
    if(!res.success){historyContainer.innerHTML='<div class="empty-state">Chyba: '+(res.error||res.message||'')+'</div>';updateLast();return;}
    receipts=res.data.receipts||[];
    renderReceipts();
  }catch(e){
    historyContainer.innerHTML='<div class="empty-state">Chyba p≈ôipojen√≠</div>';
  }
  updateLast();
}
function renderReceipts(){
  if(!receipts.length){
    historyContainer.innerHTML='<div class="empty-state"><span class="icon">üìÑ</span>≈Ω√°dn√© √∫ƒçtenky.</div>';
    return;
  }
  historyContainer.innerHTML=receipts.map(r=>`
    <div class="receipt-card fade-in">
      <div class="rc-head" style="display:flex;justify-content:space-between;align-items:flex-start;padding-bottom:6px;border-bottom:1px solid var(--c-border-soft);">
        <div class="rc-title" style="font-weight:600;font-size:.9rem;">#${r.receipt_number}</div>
        <div class="badge outline" style="font-size:.55rem;">${r.table_code||('St≈Øl '+r.table_number)}</div>
      </div>
      <div class="rc-meta">
        <div><span>Datum:</span><span>${formatDateTime(r.paid_at)}</span></div>
        <div><span>Obsluha:</span><span>${r.employee_name||'-'}</span></div>
        <div><span>Metoda:</span><span>${r.payment_method}</span></div>
        <div><span>Polo≈æky:</span><span>${r.items_count}</span></div>
      </div>
      <div class="amount-box">${formatCZK(r.total_amount)}</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn outline small" onclick="viewReceipt(${r.receipt_number})">Detaily</button>
        <button class="btn success small" onclick="reprint(${r.receipt_number})">Reprint</button>
      </div>
      ${r.reprint_count>0?`<span class="badge-floating reprint">Reprint: ${r.reprint_count}</span>`:''}
    </div>`).join('');
}
function formatDateTime(s){if(!s)return'-';return new Date(s.replace(' ','T')).toLocaleString('cs-CZ');}
function aggregateReceiptItems(items){
  const map={};(items||[]).forEach(it=>{
    const name=it.name||it.item_name||'Polo≈æka';
    const unit=Number(it.unit_price ?? it.price ?? 0);
    const note=it.note||'';
    const qty=Number(it.pay_qty ?? it.quantity ?? it.qty ?? 1);
    const key=name+'|'+unit+'|'+note;
    if(!map[key]) map[key]={name,unit_price:unit,note,quantity:0};
    map[key].quantity+=qty;
  });
  return Object.values(map);
}
async function viewReceipt(num){
  try{
    const r=await fetch(`${API}?action=get-receipt&receipt_number=${num}`).then(x=>x.json());
    if(!r.success){showPreviewError(r.error||'Chyba');return;}
    buildPreview(r.data);
  }catch(e){showPreviewError(e.message);}
}
function showPreviewError(msg){
  previewTitle.textContent='Chyba';
  previewBody.innerHTML='<div style="color:var(--c-danger-alt);font-weight:600;">'+msg+'</div>';
  previewReprintBtn.style.display='none';
  previewBg.style.display='flex';previewModal.style.display='flex';
}
function buildPreview(data){
  previewTitle.textContent='√öƒçtenka #'+data.receipt_number;
  const aggregated=aggregateReceiptItems(data.items||[]);
  const itemsHtml=aggregated.map(it=>`
    <div class="receipt-items-row">
      <div class="r-name">${it.name}${it.note?`<span class="r-note">${it.note}</span>`:''}</div>
      <div class="r-qty">${it.quantity}√ó</div>
      <div class="r-price">${formatCZK(it.unit_price*it.quantity)}</div>
    </div>`).join('')||'<div style="padding:8px 0;font-size:.6rem;color:var(--c-text-dim);">(Bez polo≈æek)</div>';
  previewBody.innerHTML=`
    <div style="font-size:.65rem;display:flex;flex-direction:column;gap:4px;margin-bottom:6px;">
      <div><strong>St≈Øl:</strong> ${data.table_code||('St≈Øl '+data.table_number)}</div>
      <div><strong>Datum platby:</strong> ${formatDateTime(data.paid_at||data.original_paid_at)}</div>
      <div><strong>Obsluha:</strong> ${data.employee_name||'-'}</div>
      <div><strong>Metoda:</strong> ${data.payment_method}</div>
      <div><strong>Polo≈æek (p≈Øvodn√≠ / zobrazeno):</strong> ${data.items_count} / ${aggregated.length}</div>
    </div>
    <div class="receipt-items">${itemsHtml}</div>
    <div class="total-line">Celkem: ${formatCZK(data.total_amount)}</div>`;
  previewReprintBtn.onclick=()=>reprint(data.receipt_number,true);
  previewReprintBtn.style.display='inline-flex';
  previewBg.style.display='flex';previewModal.style.display='flex';
}
function closeReceiptPreview(){previewBg.style.display='none';previewModal.style.display='none';}
async function reprint(num,fromPreview=false){
  try{
    const base=await fetch(`${API}?action=reprint-receipt&receipt_number=${num}`,{method:'POST'}).then(r=>r.json());
    if(!base.success){alert('Chyba reprintu: '+(base.error||base.message));return;}
    let ok=false;
    try{
      const pr=await fetch(`${API}?action=proxy-reprint`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({receipt_number:num})}).then(r=>r.json());
      ok=pr.success;
    }catch(e){}
    if(fromPreview) closeReceiptPreview();
    document.querySelectorAll('.receipt-card').forEach(c=>{
      if(c.innerHTML.includes('#'+num)){
        let b=c.querySelector('.badge-floating.reprint'); let current=0;
        if(b){const m=b.textContent.match(/(\d+)/);if(m) current=parseInt(m[1])||0;}
        if(!b){b=document.createElement('span');b.className='badge-floating reprint';c.appendChild(b);}
        b.textContent='Reprint: '+(current+1);
      }
    });
    alert(ok?'√öƒçtenka #'+num+' znovu vyti≈°tƒõna.':'Reprint ulo≈æen, tisk selhal.');
  }catch(e){alert('Chyba: '+e.message);}
}
document.addEventListener('keydown',e=>{if(e.key==='Escape') closeReceiptPreview();});
document.addEventListener('DOMContentLoaded',()=>{
  setDatesInit();
  loadFilters().then(loadReceipts);
});
</script>
</body>
</html>